# Demography and Dynamic Network Simulations {#nets}

```{r libs-ch2, echo=F, message=F, warning=F}
library(ddaf)
library(tidyverse)
library(here)
library(kableExtra)
library(EpiModel)
library(ggthemes)
library(gridExtra)
```






In mathematical models, the choice of model terms depends on the question of interest and the underlying patterns in the data and this is no less true for network models of sexual partnerships developed to understand disease transmission. Several previously published models using ERGMs and EpiModel to simulate epidemics focused on men who have sex with men (MSM) populations in a narrow age range, 18-35 (*cite papers and also double check that this is true*). These models focused on terms related to mixing patterns between races, the propensity to form relationships with individuals relatively close in age, and the likelihood of concurrent partnerships. Because prevalence of both main and casual relationships remained relatively stable over the small age range, the models did not include terms that used age as a predictor of relationship formation. However, in this project, we focus on heterosexual relationships over a larger age range (15-45). Unlike MSM, there are large clear differences in the prevalence of main and casual partnerships over this age range (\@ref(fig:egodata-prep)), so we will need to include terms that include age in our model. In addition to influencing the distribution of relationship duration, these differences are likely to be especially important if we want to use this type of model to understand the processes that generate the large observed differences in bacterial STI prevalence by age - originally one of the broader goals of this dissertation.

```{r egodata-prep, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Mean Degree by Ego Age and Relationship Type.", cache=T}
egodat <- egodata_meandegs()
egoplotdat <- cbind(egodat[[2]][,1:2], egodat[[4]][,2])
names(egoplotdat) <- c("Ego Age", "Marriage/Cohab", "Casual")
egoplotdat <-  gather(egoplotdat, Type, `Mean Degree`, -`Ego Age`)
ggplot() +
  geom_point(data=egoplotdat, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  scale_color_manual(values=c("darkblue", "darkred")) +
  theme(legend.position = c(0.15, 0.8))
```
As it turns out, adding age-related formation terms and other important demographic processes to a dynamic network simulation has some unexpected consequences.

## Base Model Overview & STERGM fit
several general trends in relationship formation (finish write-up and cite) --

-	individuals often select partners that are not their exact age
-	this difference in partner ages often increases over the life course (i.e. adults usually have wider age differences between their partners than do adolescents)
-	it is common for men to partner with younger women (although the sex differences in relationship formation are not explored in this model, it’s important to note that in a more realistic model the effect of aging out would disproportionately affect the women whose partners age out before them

(include model terms and coefs and explain terms)
(full description of EpiModelHIV module flow w/ parameters in appendix, brief overview here)

Cross network terms - we're going to avoid them due to complications  

## Overview of Demographic Processes of Interest

The simulations run using the EpiModel API are distinct from the above dynamic diagnostic in that in addition to tie formation and dissolution at every time step, a series of modules is run that govern important demographic processes: node departure, node entry, aging, and sexual debut. Nodes automatically depart the model at age 45. This boundary was determined by two things: 1) According to the CDC in their 2018 surveillance report, 97.4% of all chlamydia infections were diagnoses in the 15-44 age range (cite surveillance report) and 2) the National Survey of Family Growth, the empirical data from which we estimate our model, only surveys adults aged 15-44. There are likely other sources of information that we could use to increase the age range, but it did not seem necessary to our questions of interest. Note that implicit in this decision is the elimination of all reported relationships among egos aged 15-45 whose *partners* are outside of this age range. The degree distribution that we actually use to estimate the model (and are trying to maintain during simulation) looks rather different than the original distribution shown above, particularly in the marriage/cohabitation network (see \@ref(fig:egodata-2). We will consider the consequences of effect a later section.

```{r egodata-2, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Mean Degree by Ego Age and Relationship Type, Restricted and Unrestricted Alters", cache=T}
egoplotdat <- cbind(egodat[[2]][,1:2], egodat[[1]][,2], egodat[[4]][,2], egodat[[3]][,2])
names(egoplotdat) <- c("Ego Age", "Marriage/Cohab", "Marriage/Cohab - Restricted", "Casual", "Casual - Restricted")
egoplotdat <-  gather(egoplotdat, Type, `Mean Degree`, -`Ego Age`)
ggplot() +
  geom_point(data=egoplotdat, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

In addition to the age boundary at 45, all individuals experience the possibility of dying at each time step. Each node belongs to a class based on their 5-year-age-category and their sex, and is evaluated for death at every time step with the probability determined by data from published in U.S. Vital Statistics documents (cite). Given that our age range is relatively young, departures due to background mortality are uncommon relative to the effect of the age boundary on which nodes depart the model. Nodes enter at age 15 at a rate based on the expected number of departures per time step in order to keep the population size relatively stable. Like ASMR, the actual number of entires per time step is stochastic but maintains a population size within 1-2% of the starting size of 50,000 nodes. Each time step in the simulation represents one week, so nodes age by 1/52 per time step. Nodes enter the population at age 15 and are evaluated for sexual debut at each time step, with probability that increases until age 29 to match the age-at-debut distribution as reported in the NSFG. In accordance with the data, some individuals will never debut into the heterosexual population and will therefore never form a tie in these networks.

## Diagnostic Results  
(to demonstrate closed-system effectiveness without demography, fixed nodal attributes)  
The final step in evaluate the performance of an estimated STERGM prior to the simulation is to run a dynamic diagnostic. In this diagnostic, we simulate the STERGM for X repetitions of Y time steps and evaluate the network statistics over time. At each time step, ties can form and ties can dissolve based on the model coefficients. If the model is estimated properly and sufficient MCMC intervals are used, the network formation statistics should hover around their estimated targets. In this diagnostic we also evaluate the duration of ties and the rate of tie dissolution to ensure the dissolution targets are met. It is important to note that this diagnostic is an indicator of model performance in a closed system: all nodal attributes are fixed, no nodes exit, and no new nodes enter the population.  

```{r diagnostic-results, echo=FALSE, out.width="60%", fig.cap="Comparison: Egodata vs Diagnostic Mean Degree.", fig.align='center', cache=T}
md <- readRDS(here("Dissertation", "data", "diagnostics", "dynamic.m.nocross.rds"))
cd <- readRDS(here("Dissertation", "data", "diagnostics", "dynamic.c.nocross.rds"))

age <- md$nw %v% "age"
age_dist <- table(age)
m_el <- as.edgelist(md$nw)
m_age <- age[m_el]
m_agedist <- table(m_age)
m_meandeg <- m_agedist/age_dist

c_el <- as.edgelist(cd$nw)
c_age <- age[c_el]
c_agedist <- table(c_age)
c_meandeg <- c_agedist/age_dist

datdiag <- cbind(15:44, egodat[[1]][,2], as.numeric(m_meandeg), egodat[[3]][,2], as.numeric(c_meandeg))
colnames(datdiag) <- c("Ego Age", "Data: Marriage/Cohab", "Net Dx: Marriage/Cohab", "Data: Casual", "Net Dx: Casual")
datdiag <- gather(datdiag, Type, `Mean Degree`, -`Ego Age`)

ggplot() +
  geom_point(data=datdiag, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

```{r dynamic-duration-m, echo=F, fig.align='center', fig.cap="Mean Relationship Lengths in Diagnostic", out.width="60%", cache=T}
par(mfrow=c(1,2))
plot(md, type="duration", xlab="Diagnostic Time Step, Mar/Coh")
plot(cd, type="duration", xlab="Diagnostic Time Step, Casual")
```

takeaways:  
- reproduces mean deg dist  
- meets duration targets after time for burn in   

## Initial Simulation Results

Unlike the dynamic diagnostics, when we run these simulations with demographic processes, several metrics stray from their target values. First, the mean degree, or average number of relationships per person, is too low in both the marriage/cohabitaiton network and in the casual network (by roughly five and four percent respectively). Second, the mean relationship length is 24% too short in the marriage network but 8% too long in the casual network. Finally, the distribution of relationships across both networks is not as expected based on the empirical data. In the marriage network, there are far too few relationships among egos aged 18-31, and too many relationships in the older egos. The casual network displays a similar effect through a narrower age range. Here, the 15-22 year olds have too few relationships, the 23-34 year olds have slightly too many, and the oldest members are roughly the correct amount.

```{r load-scen1, echo=F, cache=T}
scen1 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_nooffset_no65_debut_nocorrections10.rds"))
```

```{r scen1-tab, echo=F, cache=T}
means <- calc_meandeg(scen1, 45)
kable(means, col.names = c("Target", "Base", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison, Targets and Base Simulation") %>%
  kable_styling(full_width=F)
```

```{r scen1-duration, echo=F, cache=T}
durs <- duration_calcs(scen1, 45)
kable(durs, booktabs=T, caption="Expected and Simulation Mean Relationship Length, Weeks") %>% kable_styling(full_width=F)
```

```{r scen1-networks, echo=F, fig.align='center', fig.cap="Base Simulation: Mean Degree by Age.", cache=T}
m <- marcoh_dist(scen1, 45)
c <- casual_dist(scen1, 45)
mplot <- m[[1]] +
  theme(legend.position = "none") + ggtitle("Marriage/Cohab") +
  coord_cartesian(ylim=c(0,0.75))
cplot <- c[[1]] +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) + ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))
grid.arrange(mplot, cplot, ncol=2)
```

Because we observed that in the marriage/cohabitation network there is an overrepresentation of relationships among the older egos, and the model coefficients suggests that older nodes are in general more likely to form relationships than younger nodes (with some tapering as age increases), we theorized that when a node aged 45 aged out and broke the tie with their partner (who is likely to be somewhat close in age), that the partner remaining in the simulation very quickly forms a new relationship. However, the tie that dissolved as a result of one partner leaving the simulation due to this age boundary is not a true dissolution, and these newly formed relationships should not actually exist because the remaining partner should not actually be eligible to form a new relationship in the network yet. Perhaps then, these new, short relationships in older ages contribute both to the lower than expected mean relationship duration in the marriage network and the lower than expected mean degree at younger ages.  

The sections below implement model term additions and corrections that address the various ways in which the

## Considering the effect of older partners  

We consider two ways to address the effect of partners outside the age boundary. First, we prevent egos whose partners have aged out from immediately forming new relationships by adding an offset terms for egos who meet this condition. In this scenario we hope that by preventing new relationships from forming among egos whose previous relationships were terminated artificially by the age boundary, the simulation will better match the data with the restricted alter set and increase the mean relationship length by generating new relationships at earlier ages. In the second scenario, we increase the age at which egos depart the simulation to age 65. While we may not be interested in modeling individuals older than 45 for epidemiological reasons, it may be worthwhile to keep them in the simulation over a longer period of time to avoid the artificial ending of relationships. In this case we hope to match the empirical mean degree distribution among egos with the age-unrestricted alter set. However, because we would be simulating individuals outside the age range in the data we used for estimation, we may run into additional issues.

### Offset for partner age-out

This scenario adds an offset term to the formation model (“olderpartner”) for egos whose alters are outside of the 15-45 age range modeled in the simulation. During estimation there are already some egos whose partners are outside the age range so they appear to have degree 0 and do not contributed to the expected edge count but are flagged as “olderpartner=1”. During the simulation, if an individual ages out while they are in a relationship, the remaining partner gets flagged by the “olderpartner” attribute and are prohibited from forming a new relationship. The probability of becoming available for a relationship on any future time step is equal to 1/expected duration of the relationship type, although in the case of the marriage/cohab network relationships last so long that it’s unlikely that a node become available for the rest of their simulation lifecourse (unless the age difference between partners was exceptionally large, which is not impossible).  

I don't necessarily expect this to solve the issue of the overall mean degree, but if we prevent relationships that only exist due to the age boundary, perhaps these relationships will be distributed among the younger issues. In turn these relationships would begin earlier, and possibly increase the average mean duration.   

*Results*

The first thing we note is that this offset did not largely influence the overall mean degree in either network, nor did it increase the mean relationship duration in the marriage/cohabitation network (mean relationship length was also unchanged in the casual network, but we did not necessarily expect it to). However, when comparing mean degree by age between scenarios, the offset did correct much of the overrepresentation of relationships at the older ages, and also slightly increased the mean degree in the youngers (these changes are subtle but present). The casual network was largely uninfluenced by this offset, but that would be expected given that older ages are actually less likely to form casual partnerships than younger ages.  

```{r load-scen2, echo=F, cache=T}
scen2 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_debut_nocorrections10.rds"))
```

```{r scen2-tab, echo=F, cache=T}
means2 <- calc_meandeg(scen2, 45)
kable(means2, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison, Older Partner Offset") %>%
  kable_styling(full_width=F)
```

```{r scen2-duration, echo=F, cache=T}
durs2 <- duration_calcs(scen2, 45)
kable(durs2, booktabs=T, caption="Relationship Duration: Older Partner Offset, Weeks") %>% kable_styling(full_width=F)
```


```{r scen2-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Base vs Offset.", cache=T}
m2 <- marcoh_dist(scen2, 45)
c2 <- casual_dist(scen2, 45)

alphaBlue <- rgb(red=52, blue=102, green=0, alpha=120, maxColorValue=255)
alphaGreen <- rgb(red=0, blue=0, green=102, alpha=120, maxColorValue=255)

b <- barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA, ylim=c(0,0.75))  

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(m2[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19, cex=0.8)
legend("topleft", legend = c("Base Sim", "Sim with offset", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.6)

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(c2[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[3]][,2][[1]], col="darkblue", pch=19, cex=0.8)
legend("topleft", legend = c("Base Sim", "Sim with offset", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.6)
```


### Increase age boundary

In this scenario, we hope to move the degree distribution closer to the egodata distribution with the age-unrestricted alters (blue dots) – the distribution that better represents reality. This scenario includes the offset for “older partners” but employs it in a slightly different fashion. In the previous scenario, edges dissolved artificially when one of the partners left the model at age 45. We now allow those relationships to continue as they would normally by increasing the age of departure in the model to age 65. However, we use the offset to prevent any nodes older than 45 but not in a relationship from forming new relationships. Only relationships that began prior both partners turning 45 exist.

*Results*

First off, it is clear that we can easily recover the marriage and cohabitations lost to the age boundary among egos in the 35-45 age range simply by keeping their older partners in the model, even if the data used to estimate the model did not include these partners. However, this approach has consequences. Because the model is targeting a mean degree based on the restricted partner data, the maintenence of relationships among 35-45 year olds increased the overall mean degree beyond the target and also comes at the expense of relationships among the younger ages, the section of the distribution that we already fail to match well. The mean age of relationships has increased, but this is clearly a result of the relationship at older ages, thus only a partial success. The casual network also displays some undesireable qualities similar to the cohab network. The mean degree is too low at the expense of the younger age group and the mean relationship length is unchanged.

```{r load-scen3, echo=F, cache=T}
scen3 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_yes65_debut_nocorrections10.rds"))
```

```{r scen3-tab, echo=F, cache=T}
means3 <- calc_meandeg(scen3, 65)
kable(means3, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison, Increased Age Boundary") %>%
  kable_styling(full_width=F)
```

```{r scen3-duration, echo=F, cache=T}
durs3 <- duration_calcs(scen3, 65)
kable(durs3, booktabs=T, caption="Relationship Duration: Increased Age Boundary, Weeks") %>% kable_styling(full_width=F)
```

```{r scen3-networks, echo=F, fig.align='center', fig.cap="Mean Degree Comparison: Increased Age Boundary.", cache=T}
m3 <- marcoh_dist(scen3, 65)
c3 <- casual_dist(scen3, 65)

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(m3[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[2]][,2][[1]], col="darkblue", pch=19, cex=0.8)
legend("topleft", legend = c("Base Sim", "Increased Age Boundary", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA),
       pch=c(NA, NA, 19), lwd=8, bty="n",cex=0.6)

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(c3[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[4]][,2][[1]], col="darkblue", pch=19,  cex=0.8)
legend("topleft", legend = c("Base Sim", "Increased Age Boundary", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA),
       pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.6)
```

*Discussion*

conclusion: we keep offset in all future scenarios but not older partners, older partners may be a good idea in some case but we have to rethink some things especially if the younger ages are going to perform worse

## Relationship Length & The Simulation Window

So far, nothing we have done has largely influenced the issues with relationship duration in these networks. In the marriage/cohab network, the mean duration falls nearly 2 years short of the expected length and in the casual network the mean duration is roughly 3 months too long. There are a few possible reasons that there may be a mismatch between the formation and dissolution coefficients in-simulation that may contribute to these outcomes.

```{r edcalcs, echo=F, cache=T}
dur <- scen1$param$durationMarcoh
rate <- 1/dur
# randomly generate 1000
n <- 100000
r <- rexp(n, rate)
r <- sort(r)
# density function
d <- dexp(r, rate)
data <- cbind(r, d)

# which values fall outide of time window? aka impossible to observe in our simulation
window <- 30*(365/7)
newR <- r[which(r < window)]
#newD <- dexp(newR, rate)
newDur <- mean(newR)
```

```{r plot-expdist, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Predicted Distribution of Marriage/Cohab Relationship Lengths", cache=T}
ggplot(as.data.frame(data), aes(x=r, y=d)) +
  geom_point() +
  geom_vline(xintercept=window) +
  xlab("Relationship Length, Weeks") + ylab("Density")

```

From our survival analysis it is clear that the exponential distribution, even when separated into separate networks by relationship type, had some serious limitations in its ability to represent the full distribution of relationship lengths - both by age and across the whole population. One of the limitations that may pertain to the right tail of the distribution. An exponential distribution with a mean of roughly `r round(scen1$param$durationMarcoh)` weeks (the mean cross-sectional length in the empirical data) has a very long right tail extending beyond a normal human lifespan, `r round(max(r)/52)` years. Clearly this tail isn't possible to observe, even less so when you consider that the window of observation in the simulation is equal to the age range of the population, 15-45 (30 years). \@ref(fig:plot-expdist) shows the density plot of relationships lengths that are exponentially distributed with a mean of `r round(scen1$param$durationMarcoh)` weeks. While `r round((length(newR)/length(r))*100, 2)`% of observsations lay within the simulation window, the removal of the tail lowers the mean observerable relationship length based on this distribution (the mean of relationship lengths if you remove the observations that are impossible to occur in the simulation) from `r round(scen1$param$durationMarcoh)` weeks to `r round(newDur)` weeks.   

*need figure legend, vertical line is simulation window  

In this scenario, we increase the edges formation coefficient by the difference between the log odds of the target mean duration and the log odds of the observable mean duration in the marriage network. (this may be a good time to explain the edapprox?) (also show that the "observable" mean duration in the casual network is essentially the same because the right tail truncation is so small it doesn't influence the mean much.)


- only display marriage/cohab network here b/c casual remains unchanged (no cross-network terms)


```{r load-scen5, echo=F, cache=T}
scen5 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_debut_edapprox10.rds"))
```

```{r scen5-tab, echo=F, cache=T}
means5 <- calc_meandeg(scen5, 45)
kable(means5, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison: Edapprox Correction") %>%
  kable_styling(full_width=F)
```

```{r scen5-duration, echo=F, cache=T}
durs5 <- duration_calcs(scen5, 45)
kable(durs5, booktabs=T, caption="Relationship Length: Edapprox Correction, Weeks") %>% kable_styling(full_width=F)
```

```{r scen5-marcoh, echo=F, fig.align='center', out.width="60%", fig.cap="Mean Degree Comparison: Edapprox Correction, Marriage/Cohab.", cache=T}
m5 <- marcoh_dist(scen5, 45)

alphaBlue <- rgb(red=52, blue=102, green=0, alpha=120, maxColorValue=255)
alphaGreen <- rgb(red=0, blue=0, green=102, alpha=120, maxColorValue=255)

barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(m5[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19)
legend("topleft", legend = c("Base Sim", "Edapprox Correction", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n")
```


## Formation & Departure
let's think about why we're seeing the things we are  
    * both networks have too few edges, particularly in early years  
    * both dissolution rates slightly too low  
    * marriage/cohab network: duration far too low  
    * casual network: duration too high  
    * tests:  
      * marriage/cohab -- adj formation for earlier edges and longer durations  
        * edapprox for impossible length durations - this went in the right direction but influential enough
        * add't corrections-- what does it take to hit the correct mean deg? does that help duration?  
      * casual -- adj formation for earlier edges, but also departure for too long relationships (gets back to departure correction and the likelihood that a departure eliminates an edges in this network, which I don't think I've explained yet)?  

In this scenario, I consider the


We’ve seen that there are some small adjustments that we can make to the model structure to better capture the mean degree at the youngest and oldest ages, but there remains the problem that neither the marriage/cohabitation network nor the casual network maintain the target mean degree, nor do they hit the target mean relationship duration. Issues relating to maintaining mean degree under various demographic conditions are not unheard of, and some corrections have already been implemented. For example, the issue of maintaining mean degree in a growing population has been addressed by Kritvitsky, Handcock and Morris (2011). Additionally, a departure correction exists to maintain mean degree and relationship duration in the presence of node departure (cite Steve’s document). I will briefly review this departure correction as it is currently implemented here and think through a possible extension.
Current Implementation: Departure Correction
	The node departure correction used in the model estimation-to-simulation workflow was developed after the observation that when nodes were removed from the simulation to mimic, for example, background age-specific mortality, the mean degree of the network became lower than expected, as does the mean duration of relationships. The logic is relatively straightforward: the statistical model underlying these network simulations balances the probability of tie formation with the probability of tie dissolution in order to maintain a target number of ties in the network. However, when nodes depart, some additional ties will break due to this process, lowering mean degree and the mean duration of ties. This node death is exogenous to the originally estimated statistical model, and therefore “unexpected”. To counter the lowering of relationship duration (and subsequently mean degree) related this excess node death, the expected (endogenous) duration of ties is increased such that the *average* duration is maintained.  
	The departure correction implemented in previous models has two components: 1) the mortality rate per time step averaged across the entire population, and 2) the rate at which individuals depart the simulation due to the age boundary, calculated as 1/(time steps each node is expected to be observed in the simluation). In the past this approach has

```{r load-scen6, echo=F, cache=T}
scen6 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_debut_edapprox_mort10.rds"))
```

```{r scen6-tab, echo=F, cache=T}
means6 <- calc_meandeg(scen6, 45)
kable(means6, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison: Edapprox Correction") %>%
  kable_styling(full_width=F)
```

```{r scen6-duration, echo=F, cache=T}
durs6 <- duration_calcs(scen6, 45)
kable(durs6, booktabs=T, caption="Relationship Length: Edapprox Correction, Weeks") %>% kable_styling(full_width=F)
```

```{r scen6-networks, echo=F, fig.align='center', fig.cap="Mean Degree Comparison: Departure Corrections.", cache=T}
m6 <- marcoh_dist(scen6, 45)
c6 <- casual_dist(scen6, 45)

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(m6[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19)
legend("topleft", legend = c("Base Sim", "Edapprox Correction", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n")

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(c6[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[3]][,2][[1]], col="darkblue", pch=19)
legend("topleft", legend = c("Base Sim", "Eligibility", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n")
```

```{r summary-table, echo=F}
tab <- cbind(means[,1:2], means2[,2], means3[,2], means5[,2], means6[,2])
colnames(tab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure")
kable(tab, booktabs=T, caption = "Mean Degree Comparison Summary Table") %>%
  kable_styling(full_width=F)
```

```{r summary-durs, echo=F}
durstab <- cbind(durs[,1:2], durs2[,2], durs3[,2], durs5[,2], durs6[,2])
colnames(durstab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure")
kable(durstab, booktabs=T, caption = "Mean Relationship Duration Comparison Summary Table") %>%
  kable_styling(full_width=F) %>%
  column_spec(2:3, width = "5cm")
```


## Sexual Debut

```{r load-scen4, echo=F, cache=T}
scen4 <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_eligible_withcorrections.rds"))
```

Representing the sexual debut process is both complex and highly important if we wish to model sexually transmitted diseases in adolesents and young adults. In the U.S., more than 50% of all sexually transmitted bacterial infections such as chlamydia and gonorrhea diagnosed yearly occur among individuals aged 15-24, but not everyone in the age group are sexually active, which concentrates the transmissions into subset of the population and increases the probability of exposure to an STI for those sexually active moreso than at older ages. It is important then, to approximate this process in simulation as faithfully as possible. If too many individuals are able to form sexual partnerships in the model, we risk under-estimating the risk of exposure for those sexually active and conversely over-estimating the risk of exposure if too few are sexually active.  

Estimating and simulating the sexual debut process is complex for several reasons. First, because our empirical data is cross-sectional, the proportion of individuals at each age who have sexually debuted at the time of their interview is not necessarily monotonic, but is mostly monotonic for the formative debut years - until roughly 97% of the population has reported sex with an opposite-sex partner. In the simulation we stop estimating debut after this threshold is reached around age 29, meaning not every person will have an opposite-sex partnership. This way we use the population composition of the NSFG but do not have to beforehand decide which members of the population will debut heterosexually. The second complicating factor is that the rate of debut is clearly not consistent across ages 15-29. The proportion of individuals who report having had at least one opposite-sex sexual partner rapidly increases throughouht the late teen and early 20s, and then slows. Bearing this in mind...I then used this data....fit the models...different parameters by age groups....representing weekly probability of debut.


 insert debut table graph
```{r debut-table, echo=FALSE, eval=FALSE}
ages <- 15:44

# cross-sectional debut status
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# average proportion debut by age for the population (at what age did they debut)
data_debut_total <- c(17.7, 13.7, 17.9, 15.1, 12.0,  6.6,  4.3,  2.9,  2.4,  1.9,  1.6,  0.8,  0.4,  0.3,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,  0.0, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0, 0.0, 0.0)

data_debut_summed <- rep(NA, length(data_debut_total))
data_debut_summed[1] <- 17.7
for (i in 2:length(data_debut_total)) {
  data_debut_summed[i] <- data_debut_total[i] + data_debut_summed[i-1]
}
# dist of debut in default debut scenarios
sim_debut  <- apply(scen1$epi$debutprop, 1, mean)*100
#sim_debut <- c(0, sim_debut)

# dist of "eligibility"
sim_elig  <- apply(scen4$epi$debutprop, 1, mean)*100
#sim_elig <- c(50, sim_elig)

elig2 <-  c(0.3890241, 0.5387553, 0.6486685, 0.7232390, 0.7790754, 0.8145622, 0.8710085, 0.9028383, 0.9201664, 0.9362966, 0.9531320, 0.9636948, 0.9703411, 0.9758518, 0.9831308, 0.9836857, 0.9844340, 0.9865116, 0.9815556, 0.9870843, 0.9799242, 0.9828702, 0.9828286, 0.9850692, 0.9851530, 0.9832649, 0.9862478, 0.9850170, 0.9831302, 0.9847444)*100

debut <- as.data.frame(cbind(ages, data_debut_cs, sim_debut, elig2, sim_elig))
debut <- gather(debut, key="Data", value = "Debut", -ages)

ggplot(debut, aes(x=ages, y=Debut, col=Data)) +
  geom_point()

plot(data_debut_cs, col="orange")
#points(data_debut_summed, col="red")
points(sim_debut, col="blue")
points(sim_elig, col="purple")

```

The major caveat to this approach is that it does not mechanistically represent the debut process as well as desired . In real life, a person "debuts" by entering into a sexual partnership. This puts the model in a bit of a catch-22 situation: an individual can't debut in real life until they form a sexual partnership, but in order to form a sexual partnership in the model, they must already be "debuted". We can match the distribution of sexually debuted individuals, but it is possible that the number of individiduals who have "debuted" does not equal the number of individuals who have actually formed a relationship at any point in the simulation.

And indeed this is the case - talk about effective debut






What if instead we used the "debut" term to model the idea of "sexual eligibility" rather than explictly debut? The concept is straightforward: in most cases, an individual would decide that they are *ready* to begin having sex some period of time prior to actually forming a sexual partnership (or transitioning a relationship from a non-sexual partnership to a sexual one). It is perhaps this underlying trait that we should model instead, allowing us to model the sexual history of individuals in our model more completely. Unfortunately our survey data don't allow us to answer this question directly (i.e. at what age did you decide you were ready for sex vs at what age did you actually start having sex), and the literature has laregly focused more on individual characteristics and within-partership dynamics that predict sexual debut rather than quantifying the time to readiness or the time from readiness to debut (cite that review paper, others).

However, it is possible that the mis-match between what the "debuted" term acts in our model and what it represents in real life contibutes to why our mean degree among the younger population in both networks is too low, so in this scenario we alter  

  now, in this model setup, the rate of sexual debut does not influence the birth/arrival rate in the model - as mentioned above the model is designed to have a relatively stable population with an arrival rate based on the expected number of departures at each time step. Sexual debut however does dictate whether an individual is allowed to form a relationship, and the number of un-debut persons is jointly estimated in the model, so deviations from the original distribution will influence the likelihood of tie formation...

*Results*  

The switch to an "eligibility" metric had some dramatic effects on the casual network and to a lesser extend the marriage/cohabitation network. In the marriage network, the overall mean degree has increased to only about 1% less than the target, and although we see increases in the mean degree across almost all ages, the effect is larger in the younger half of the population. However the added number of egos available to form a marriage or cohabitation has not helped us enough to meet our by-age targets in this subset. The increase in the number of realtionships that begin at earlier ages has increased the mean relationship length by about 2.5 months, but we still fall far short of the target. In the casual network, the increase in available egos for casual relationships has led to a large increase in the mean degree in the younger ages. In fact, the distribution comes very close to the mean degree targets though adolesence and the early 20s, but exceeds the targets until roughly age 30. The overall increase in relationships leads this network to also exceed the target mean degree by roughly 20%.

but -- let's look at actual debut in-simulation
neither approach fits data  

*1-Year Eligibility*

```{r scen4-tab, echo=F, cache=T}
means_e <- calc_meandeg(scen4, 45)
kable(means_e, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison: 1-Year Eligibility") %>%
  kable_styling(full_width=F)
```

```{r scen4-duration, echo=F, cache=T}
durs_e <- duration_calcs(scen4, 45)
kable(durs_e, booktabs=T, caption="Relationship Length, 1-Year Eligibility, Weeks") %>% kable_styling(full_width=F)
```

```{r scen4-networks, echo=F, fig.align='center', fig.cap="Mean Degree Comparison: Eligibility.", cache=T}
m4 <- marcoh_dist(scen4, 45)
c4 <- casual_dist(scen4, 45)

alphaBlue <- rgb(red=52, blue=102, green=0, alpha=120, maxColorValue=255)
alphaGreen <- rgb(red=0, blue=0, green=102, alpha=120, maxColorValue=255)

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(m4[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19, cex=0.7)
legend("topleft", legend = c("Base Sim", "1-Year Eligibility", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n")

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(c4[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[3]][,2][[1]], col="darkblue", pch=19)
legend("topleft", legend = c("Base Sim", "1-Year Eligibility", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n")
```

*Calibrated Eligibility*  
```{r load-calibrated-elig, echo=F, cache=T}
calibelig <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_calibratedeligible_withcorrections.rds"))
```


```{r calib-elig-tab, echo=F, cache=T}
means_ce <- calc_meandeg(calibelig, 45)
kable(means_ce, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison, Calibrated Eligibility") %>%
  kable_styling(full_width=F)
```

```{r calib-elig-duration, echo=F, cache=T}
durs_ce <- duration_calcs(calibelig, 45)
kable(durs_ce, booktabs=T, caption="Relationship Duration: Calibrated Eligibility, Weeks") %>% kable_styling(full_width=F)
```


```{r calib-elig-networks, echo=F, fig.align='center', fig.cap="Mean Degree Comparison: Calibrated Eligibility.", cache=T}
me <- marcoh_dist(calibelig, 45)
ce <- casual_dist(calibelig, 45)

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(me[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19, cex=0.7)
legend("topleft", legend = c("Base Sim", "Calibrated Eligibility", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.5)

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,ylim=c(0,0.75))
barplot(ce[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[3]][,2][[1]], col="darkblue", pch=19, cex=0.7)
legend("topleft", legend = c("Base Sim", "Calibrated Eligibility", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.5)
```

*Young Age Formation Boost*  
```{r load-youngboost, echo=F, cache=T}
youngboost <- readRDS(here("Dissertation", "data", "small", "nocrossterms_yesoffset_no65_debut_nodefactor_withcorrections.rds"))
```

```{r youngboost-tab, echo=F, cache=T}
means_yb <- calc_meandeg(youngboost, 45)
kable(means_yb, col.names = c("Target Mean Degree", "Sim Mean Degree", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree Comparison, Young Age Formation Boost") %>%
  kable_styling(full_width=F)
```

```{r youngboost-duration, echo=F, cache=T}
durs_yb <- duration_calcs(youngboost, 45)
kable(durs_yb, booktabs=T, caption="Relationship Duration: Young Age Formation Boost, Weeks") %>% kable_styling(full_width=F)
```


```{r youngboost-networks, echo=F, fig.align='center', fig.cap="Mean Degree Comparison: Young Age Formation Boost.", cache=T}
myb <- marcoh_dist(youngboost, 45)
cyb <- casual_dist(youngboost, 45)

par(mfrow=c(1,2))
barplot(m[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,ylim=c(0,0.75))
barplot(myb[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[1]][,2][[1]], col="darkblue", pch=19, cex=0.7)
legend("topleft", legend = c("Base Sim", "Young Boost", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.5)

barplot(c[[2]]$`Final State of Network`, col=alphaGreen, ylab="Mean Degree", xlab = "Age", border=NA,
            ylim=c(0,0.75))
barplot(cyb[[2]]$`Final State of Network`, add=T, col=alphaBlue, border=NA)
points(x=b[,1], y=egodat[[3]][,2][[1]], col="darkblue", pch=19, cex=0.7)
legend("topleft", legend = c("Base Sim", "Young Boost", "Egodata"), col = c(alphaGreen, alphaBlue, "darkblue"), lty=c(1,1, NA), pch=c(NA, NA, 19), lwd=8, bty="n", cex=0.5)
```


```{r effective-debut-comparison, echo=F, fig.align="center", fig.cap="Percent Debuted In-Sim vs Data, Various Scenarios", out.width="80%"}
ages <- 15:44
# calibrated eligibility
eff_deb_calib <- apply(calibelig$epi$effectivedebutprop, 1, mean)*100

# from 10_1560 debut tracking sim
eff_deb_og <-  c(0.009363789, 0.058941781, 0.143552769, 0.240848193, 0.342852143, 0.434738607, 0.516314476, 0.594444046, 0.667909422, 0.728130341, 0.776367836, 0.820359054, 0.859432090, 0.883728213, 0.910764401, 0.927208922, 0.940291619, 0.947551619, 0.957545890, 0.962237502, 0.967736873, 0.969386924, 0.973694229, 0.973994443, 0.973894251, 0.975585668, 0.975469400, 0.978392997, 0.978194968, 0.980508975)*100

# cross-sectional debut status (empirical)
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# eligibility
oneyear_elig <- apply(scen4$epi$effectivedebutprop, 1, mean)*100

# from youngboost
youngboost_deb <- apply(youngboost$epi$effectivedebutprop, 1, mean)*100

# scenario with NO debut terms - just effective debut tracking
nodebut <- c(0.0669383, 0.1859052, 0.2767750, 0.4112038, 0.5119332, 0.5817972, 0.6477404 ,0.7087435 ,0.7698317, 0.8181818 ,0.8479064, 0.8907168 ,0.9265672 ,0.9418398, 0.9580587, 0.9682825, 0.9748391 ,0.9816303, 0.9861111 ,0.9896468 ,0.9900990, 0.9859155,0.9951865 ,0.9981297 ,0.9951691 ,0.9969679, 0.9993846, 0.9994114 ,0.9994001, 0.9993675)*100

debut2 <- as.data.frame(cbind(ages, data_debut_cs, eff_deb_calib, eff_deb_og, oneyear_elig, youngboost_deb, nodebut))
colnames(debut2) <- c("Age", "Data (NSFG)", "Elig. Calibrated", "Default", "Eligibilty, 1-year", "Default + Young Boost", "No Debut Term")
debut2 <- gather(debut2, key="Data", value = "Debut", -Age)

ggplot(debut2, aes(x=Age, y=Debut, col=Data)) +
  geom_point(aes(shape=Data), size=2.5) +
  theme(legend.position = c(.75, .45)) +
  scale_color_stata() +
  ylab("Percent Sexually Debuted")
```

```{r debut-summary-tab, echo=F}
debut_means <- cbind(means6[,1:2], means_e[,2], means_ce[,2], means_yb[,2])
colnames(debut_means) <- c("Target", "Default Debut", "1-Year Elig", "Calibrated Elig", "Young Formation Boost")
kable(debut_means, booktabs=T, caption = "Mean Degree Comparison Summary Table, Sexual Debut Corrections") %>%
  kable_styling(full_width=F)
```

```{r debut-summary-dur, echo=F}
debut_durs <- cbind(durs6[,1:2], durs_e[,2], durs_ce[,2], durs_yb[,2])
colnames(debut_durs) <- c("Target", "Default Debut", "1-Year Elig", "Calibrated Elig", "Young Formation Boost")
kable(debut_durs, booktabs=T, caption = "Mean Relationship Duration Summary Table, Sexual Debut Corrections") %>%
  kable_styling(full_width=F)
```

### *Discussion*
 - not a one-size-fits-all solution
 - still concerned about who in the population is sexually active and the under/overestimate of exposure risk
 - really hard to empirically estimate "eligibility" concept, probably so related to potential-sexual-partnership dyanmics it's hard to say if this correction was even close to truth  

- using and "effective debut" metric of who has ever had a relatinship over the course of the simulation reveals that neither approach hits target actual debut

but again related to estimation mis-match between estimation and simulation



conclusion: continue to use debut not eligibility  





## OTHER - age dist??  
should I have a section on the age distribution? it levels out to be slightly different than the egodata, which likely has some influence but is unlikely to be the reason for the massive gap in the younger age mean degree dist  

## future work  
  * cross-network terms - probably going to do most analysis on the independent networks but will show both and point at where there are holes (hey by the time this gets finished maybe Chad will have already figured this out)  
  * need to think about race and sex differences in formation and absdiff(age) by sex if we want to use this for applied work  
