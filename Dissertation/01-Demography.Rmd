# Demography and Dynamic Network Simulations {#nets}

```{r libs-ch1, echo=F, message=F, warning=F}
library(ddaf)
library(tidyverse)
library(here)
library(kableExtra)
library(EpiModel)
library(ggthemes)
library(gridExtra)

alphaBlue <- rgb(red=52, blue=102, green=0, alpha=120, maxColorValue=255)
alphaGreen <- rgb(red=0, blue=0, green=102, alpha=120, maxColorValue=255)
```

In mathematical models the choice of model terms depends on the question of interest and the underlying patterns in the data and this is no less true for network models of sexual partnerships developed to understand disease transmission. Several previously published models using ERGMs and EpiModel to simulate epidemics focused on men who have sex with men (MSM) populations in a narrow age range, 18-35 (*cite papers and also double check that this is true*). These models focused on terms related to mixing patterns between races, the propensity to form relationships with individuals relatively close in age, and the likelihood of concurrent partnerships. Because prevalence of both main and casual relationships remained relatively stable over the small age range, the models did not include terms that used age as a predictor of relationship formation. However, in this project, we focus on heterosexual relationships over a larger age range (15-45). Unlike the narrower MSM models, there are large clear differences in the prevalence of main and casual partnerships over this age range, so we will need to include terms that involve age in our model (see appendix for breakdown of empirical data relevant to the model terms). In addition to influencing the distribution of relationship duration, these differences are likely to be especially important if we want to use this type of model to understand the processes that generate the large observed differences in bacterial STI prevalence by age - one of the broader goals of this dissertation.
However, while individual age is straightforward to represent in the model, it introduces several complicating factors for network models largely related to the boundaries imposed by age range and the aging process. This is not the first simulation to incorportae vital dynamics, and there are a few existing corrections relating to these processes already implemented

In this chapter, first I will show the relevant diagnostics demonstrating that the estimated model itself reproduces key network statistics in the absence of dynamic vital processes. Then I will show document how simulations that incorporate individual births, deaths, aging, and sexual debut lead the network to deviate from these key statistics. Third, I will explore the possible underlying causes for these deviations, implement a variety of corrections (some new, some extensions of previously implmented corrections), evaluate the efficacy of each, and outline some possible future directions for improved simulations.


## Some Definitions  
  
*Static Diagnostic:* Simulates networks based on the STERGM model fit and reports summary statistics for formation model terms. These networks are not dynamic, thus no dissolution or durational statistics are reported.  
*Dynamic Diagnostic:* The dynamic diagnostic simulates the networks over time and tracks cross-sectional summary statistics for the formation model terms as well as dissolution model and relational duration statistics. This is a closed system: nodes do not depart, new nodes do not arrive, and no nodal attributes change across the simulation period (i.e. if you are age 15 when then the diagnostic begins, you remain 15 for the entire run).   
*Simulation:* While the static and dynamic diagnostics are run using simulation methods, when I refer to the "simulation" I am referring to the simulation using the EpiModel API that controls vital dynamics and other processes like sexual debut and eventually, disease transmission.  
*Node / Ego:* An individual in the network.  
*Nodal Attribute:* A trait of an individual (sex, age, sexual debut status, etc)

## Base Model Overview

The base network models we use for this chapter focus largely on the age effects of relationship formation, with additional terms and structural offsets. For epidemic modeling purposes it will be important to also model race/ethnicity due to the existence of large racial dispartiies in prevalence of several sexually transmitted diseases, but that additional complexity is not the focus here. 

[network terms]

## Closed-System Results  

One of the several steps to check model fit and convergence is a dynamic diagnostic. In this diagnostic, we simulate the STERGM for X repetitions of Y time steps and evaluate the cross-sectional network statistics over time. At each time step, ties can form and ties can dissolve based on the model coefficients. If the model is estimated properly and sufficient MCMC intervals are used, the network formation statistics should hover around their estimated targets. In this diagnostic we also evaluate the duration of ties and the rate of tie dissolution to ensure the dissolution targets are met. It is important to note that this diagnostic is an indicator of model performance in a closed system: all nodal attributes are fixed, no nodes exit, and no new nodes enter the population. 
In this context the models perform exceptionally well. Not only is the overall mean degree of each network met, but mean degree by age in both networks is reproduced well. Additionally, both models reach the target mean cross-sectional relationship duration after sufficient time. Any deviation from these targets as we move to the simulation then, will be related to the introduction of vital dynamics and other processes like sexual debut that alter nodal attributes that model terms. 

```{r diagnostic-results, echo=FALSE, out.width="60%", fig.cap="Comparison: Egodata vs Diagnostic Mean Degree.", fig.align='center', cache=T}
egodat <- egodata_meandegs()

md <- readRDS(here("Dissertation", "data", "diagnostics", "dynamic.m.nocross.rds"))
cd <- readRDS(here("Dissertation", "data", "diagnostics", "dynamic.c.nocross.rds"))

age <- md$nw %v% "age"
age_dist <- table(age)
m_el <- as.edgelist(md$nw)
m_age <- age[m_el]
m_agedist <- table(m_age)
m_meandeg <- m_agedist/age_dist

c_el <- as.edgelist(cd$nw)
c_age <- age[c_el]
c_agedist <- table(c_age)
c_meandeg <- c_agedist/age_dist

m_mean <- round(mean(m_meandeg),3)
c_mean <- round(mean(c_meandeg),3)

datdiag <- cbind(15:44, egodat[[1]][,2], as.numeric(m_meandeg), egodat[[3]][,2], as.numeric(c_meandeg))
colnames(datdiag) <- c("Ego Age", "Data: Marriage/Cohab", "Net Dx: Marriage/Cohab", "Data: Casual", "Net Dx: Casual")
datdiag <- gather(datdiag, Type, `Mean Degree`, -`Ego Age`)

ggplot() +
  geom_point(data=datdiag, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

```{r dynamic-duration-m, echo=F, fig.align='center', fig.cap="Mean Relationship Lengths in Diagnostic", out.width="60%", cache=T}
par(mfrow=c(1,2))
plot(md, type="duration", xlab="Diagnostic Time Step, Mar/Coh")
plot(cd, type="duration", xlab="Diagnostic Time Step, Casual")
```


## Overview of Demographic Processes of Interest

The simulations run using the EpiModel API are distinct from the above closed-system dynamic diagnostic in that in addition to tie formation and dissolution at every time step, a series of modules is run that govern important demographic processes: node departure, node entry, aging, and sexual debut. Nodes automatically depart the model at age 45. This boundary was selected for two main reasons: 1) According to the CDC in their 2018 surveillance report, 97.4% of all chlamydia infections were diagnoses in the 15-44 age range (cite surveillance report) and 2) the National Survey of Family Growth, the empirical data from which we estimate our model, only surveys adults aged 15-44. There are likely other sources of information that we could use to increase the age range, but it did not seem necessary to our questions of interest. Note that implicit in this decision is the elimination of all reported relationships among egos aged 15-45 whose *partners* are outside of this age range. The degree distribution that we actually use to estimate the model (and are trying to maintain during simulation) looks rather different than the original distribution shown above, particularly in the marriage/cohabitation network (see \@ref(fig:egodata-2). We will consider the consequences of this in a later section.

```{r egodata-2, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Mean Degree by Ego Age and Relationship Type, Restricted and Unrestricted Alters", cache=T}
egoplotdat <- cbind(egodat[[2]][,1:2], egodat[[1]][,2], egodat[[4]][,2], egodat[[3]][,2])
names(egoplotdat) <- c("Ego Age", "Marriage/Cohab", "Marriage/Cohab - Restricted", "Casual", "Casual - Restricted")
egoplotdat <-  gather(egoplotdat, Type, `Mean Degree`, -`Ego Age`)
ggplot() +
  geom_point(data=egoplotdat, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

In addition to the age boundary at 45, all individuals experience the possibility of dying at each time step. Each node belongs to a class based on their 5-year-age-category and their sex, and is evaluated for death at every time step with the probability determined by data from published in U.S. Vital Statistics documents (cite). Given that our age range is relatively young, departures due to background mortality are uncommon relative to the effect of the age boundary on which nodes depart the model. Nodes enter at age 15 at a rate based on the expected number of departures per time step in order to keep the population size relatively stable. Like ASMR, the actual number of entires per time step is stochastic but maintains a population size within 1-2% of the starting size of 50,000 nodes. Each time step in the simulation represents one week, so nodes age by 1/52 per time step. Nodes enter the population at age 15 and are evaluated for sexual debut at each time step, with probability that increases until age 29 to match the age-at-debut distribution as reported in the NSFG. In accordance with the data, some individuals will never debut into the heterosexual population and will therefore never form a tie in these networks.


## Initial Simulation Results

Unlike the dynamic diagnostics, when we run these simulations with demographic processes, several metrics stray from their target values. First, the overall network mean degree, or average number of relationships per person, is too low in both the marriage/cohabitaiton network and in the casual network (by roughly five and three percent respectively). These deviations are not incredibly large, but they are somewhat concerning esepcially becuase Second, the mean degree by age is severally underpresented in both networks for the youngest ages but overrepreseted in the mid-30s. Finally, the mean relationship length is 24% too short in the marriage network but 7% too long in the casual network. 

```{r load-simdata, echo=F, cache=T}
dat <- readRDS(here("Dissertation", "data", "summary_sims.rds"))
```

```{r scen1-tab, echo=F, cache=T}
means1 <- cbind(dat[[1]]$meandegs, dat[[1]]$meandurs)
kable(means1, col.names = c("Mean Degree Target", "Base", "Pct Off",
                                       "Mean Duration Target", "Base", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets and Base Simulation") %>%
  kable_styling(full_width=F)
```

```{r scen1-networks, echo=F, fig.align='center', fig.cap="Base Simulation: Mean Degree by Age.", cache=T, out.width="80%"}
mdat <- as.data.frame(dat[[1]]$marcoh)
cdat <- as.data.frame(dat[[1]]$casual)
m <- ggplot() +
     geom_bar(data = mdat, aes(x=`Ego Age`, y=`Final State of Network`, fill="Final State of Network"), stat = "identity", fill="#999999") +
    geom_point(mdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata - Restricted`, color="Weighted Egodata - Restricted"))  +
    geom_point(mdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata`, color="Weighted Egodata"))+
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Egodata",
                       labels = c("Weighted Egodata", "Weighted Egodata, All Alters"),
                       values = c("darkblue", "darkred")) +
  theme(legend.position = "none") + ggtitle("Marriage/Cohab") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
      geom_bar(cdat, mapping=aes(x=`Ego Age`, y=`Final State of Network`, fill="Final State of Network"), stat = "identity", fill="#999999") +
      geom_point(cdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata - Restricted`, color="Weighted Egodata - Restricted"))  +
      geom_point(cdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata`, color="Weighted Egodata"))+
      xlab("Ego Age") +
      ylab("Mean Degree") +
      scale_color_manual(name = "Egodata",
                         labels = c("Weighted Egodata", "Weighted Egodata, All Alters"),
                         values = c("darkblue", "darkred")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) + ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

## Boundary Effects & Existing Corrections

This section provides an overview of existing corrections for dynamic networks and dynamic demography and outlines the boundary effect issues that we will explore in more detail below. 

**1. Formation Approximation**
In many cases, a full STERGM cannot directly be estimated directly due to the computational burden when networks are large, sparse, and have relatively long relational durations (which describes many sexual networks). Instead @Carnegie2015 introduce an approximation to full STERGM estimation that uses the same data: cross-sectional egocentric network data and information on tie duration. In this approximation, the static ERGM is estimated using standard techniques. Then the edges formation term (which represents the base propensity for ties to form between any two individuals in the network) is decreased by the log odds of the probability of edge persistence, in effect transforming the formation term from *prevalence* of ties in the network to the *incidence* of ties. The explorations below do not attempt to modify this approach, but instead explore the relationship between the adjustment of the formation coefficient, the probabilty of tie persistence as estimated from the long relationship duration expected in the marriage network relative to the limited observation window per individual as they arrive and eventually age out.  
**2. Right Boundary Existing Correction: Departure**
The node departure correction used in the model estimation-to-simulation workflow was developed after the observation that when nodes were removed from the simulation to mimic, for example, background age-specific mortality, the mean degree of the network became lower than expected, as does the mean duration of relationships. The logic is relatively straightforward: the statistical model underlying these network simulations balances the probability of tie formation with the probability of tie dissolution in order to maintain a target number of ties in the network. However, when nodes depart, some additional ties will break due to this process, lowering mean degree and the mean duration of ties. This node death is exogenous to the originally estimated statistical model, and therefore “unexpected”. To counter the lowering of relationship duration (and subsequently mean degree) related this excess node death, the expected (endogenous) duration of ties is increased such that the *average* duration is maintained.  
The departure correction implemented in previous models has two components: 1) the mortality rate per time step averaged across the entire population, and 2) the rate at which individuals depart the simulation due to the age boundary, calculated as 1/(time steps each node is expected to be observed in the simluation). In the past this approach has successfully....

However, due to the large difference in average probability of breaking a tie upon departer between the marriage/cohab network and the casual network (due to the distribution of mean degree by age), it seems unlikely that the departure correction should be the same for both networks. 
**3. Left Boundary Existing Correction: Arrival**
Kritvitsky, Handcock and Morris (2011) - this correction is designed to maintain the target mean degree of the network in the presence of changes in the size of the population. In these simulations, while the exact number of entries at every time step is stochastic, the rate is designed to keep the population size relatively stable so while we do use this correction, we will not futher modify it. 
However, another arrival-related problem is the issue is that fact that nodes do not enter the population *with* ties to other nodes. While the model coefficients suggest a certain average number of relationships among these young adults, because the nodes age each week, there is a very limited time frame in which to form relationships and hit these targets. 


## Considering the effect of older partners  
Because we observed that in the marriage/cohabitation network there is an overrepresentation of relationships among the older egos, and the model coefficients suggests that older nodes are in general more likely to form relationships than younger nodes (with some tapering as age increases), we theorized that when a node aged 45 aged out and broke the tie with their partner (who is likely to be somewhat close in age), that the partner remaining in the simulation very quickly forms a new relationship. However, the tie that dissolved as a result of one partner leaving the simulation due to this age boundary is not a true dissolution, and these newly formed relationships should not actually exist because the remaining partner should not actually be eligible to form a new relationship in the network yet. Perhaps then, these new, short relationships in older ages contribute both to the lower than expected mean relationship duration in the marriage network and the lower than expected mean degree at younger ages.  

We consider two ways to address the effect of partners outside the age boundary. First, we prevent egos whose partners have aged out from immediately forming new relationships by adding an offset terms for egos who meet this condition. In this scenario we hope that by preventing new relationships from forming among egos whose previous relationships were terminated artificially by the age boundary, the simulation will better match the data with the restricted alter set and increase the mean relationship length by generating new relationships at earlier ages. In the second scenario, we increase the age at which egos depart the simulation to age 65. While we may not be interested in modeling individuals older than 45 for epidemiological reasons, it may be worthwhile to keep them in the simulation over a longer period of time to avoid the artificial ending of relationships. In this case we hope to match the empirical mean degree distribution among egos with the age-unrestricted alter set. However, because we would be simulating individuals outside the age range in the data we used for estimation, we may run into additional issues.

### Offset for Partner Age-Out

This scenario adds an offset term to the formation model (“olderpartner”) for egos whose alters are outside of the 15-45 age range modeled in the simulation. During estimation there are already some egos whose partners are outside the age range so they appear to have degree 0 and do not contributed to the expected edge count but are flagged as “olderpartner=1”. During the simulation, if an individual ages out while they are in a relationship, the remaining partner gets flagged by the “olderpartner” attribute and are prohibited from forming a new relationship. The probability of becoming available for a relationship on any future time step is equal to 1/expected duration of the relationship type, although in the case of the marriage/cohab network relationships last so long that it’s unlikely that a node become available for the rest of their simulation lifecourse (unless the age difference between partners was exceptionally large, which is not impossible).  

I don't necessarily expect this to solve the issue of the overall mean degree, but if we prevent relationships that only exist due to the age boundary, perhaps these relationships will be distributed among the younger issues. In turn these relationships would begin earlier, and possibly increase the average mean duration.   

*Results*

The first thing we note is that this offset did not largely influence the overall mean degree in either network, nor did it increase the mean relationship duration in the marriage/cohabitation network (mean relationship length was also unchanged in the casual network, but we did not necessarily expect it to). However, when comparing mean degree by age between scenarios, the offset did correct much of the overrepresentation of relationships at the older ages, and also slightly increased the mean degree in the youngers (these changes are subtle but present). The casual network was largely uninfluenced by this offset, but that would be expected given that older ages are actually less likely to form casual partnerships than younger ages.  

```{r scen2-tab, echo=F, cache=T}
means2 <- cbind(dat[[2]]$meandegs, dat[[2]]$meandurs)
kable(means2, col.names = c("Mean Degree Target", "Base", "Pct Off",
                                       "Mean Duration Target", "Base", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Older Partner Offset") %>%
  kable_styling(full_width=F)
```

```{r scen2-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Base vs Offset.", cache=T}
m2 <- as.data.frame(dat[[2]]$marcoh)
c2 <- as.data.frame(dat[[2]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Offset", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Offset", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Offset Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Offset Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


#### Increase Age Boundary

In this scenario, we hope to move the degree distribution closer to the egodata distribution with the age-unrestricted alters (blue dots) – the distribution that better represents reality. This scenario includes the offset for “older partners” but employs it in a slightly different fashion. In the previous scenario, edges dissolved artificially when one of the partners left the model at age 45. We now allow those relationships to continue as they would normally by increasing the age of departure in the model to age 65. However, we use the offset to prevent any nodes older than 45 but not in a relationship from forming new relationships. Only relationships that began prior both partners turning 45 exist.

*Results*

First off, it is clear that we can easily recover the marriage and cohabitations lost to the age boundary among egos in the 35-45 age range simply by keeping their older partners in the model, even if the data used to estimate the model did not include these partners. However, this approach has consequences. Because the model is targeting a mean degree based on the restricted partner data, the maintenence of relationships among 35-45 year olds increased the overall mean degree beyond the target and also comes at the expense of relationships among the younger ages, the section of the distribution that we already fail to match well. The mean age of relationships has increased, but this is clearly a result of the relationship at older ages, thus only a partial success. The casual network also displays some undesireable qualities similar to the cohab network. The mean degree is too low at the expense of the younger age group and the mean relationship length is unchanged.

```{r scen3-tab, echo=F, cache=T}
means3 <- cbind(dat[[3]]$meandegs, dat[[3]]$meandurs)
kable(means3, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Increased Age Boundary") %>%
  kable_styling(full_width=F)
```

```{r scen3-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Increased Age Boundary.", cache=T}
m2 <- as.data.frame(dat[[3]]$marcoh)
c2 <- as.data.frame(dat[[3]]$casual)

scen2m <- cbind(m2, mdat[,4])
colnames(scen2m)[4:5] <- c("Increased Age Boundary", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2, cdat[,4])
colnames(scen2c)[4:5] <- c("Increased Age Boundary", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Increased Age Boundary",
                                   "Weighted Egodata", "Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkred", "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Increased Age Boundary",
                                   "Weighted Egodata", "Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkred", "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

*Discussion*

conclusion: we keep offset in all future scenarios but not older partners, older partners may be a good idea in some case but we have to rethink some things especially if the younger ages are going to perform worse

## Relationship Length & The Simulation Window

So far, nothing we have done has largely influenced the issues with relationship duration in these networks. In the marriage/cohab network, the mean duration falls nearly 2 years short of the expected length and in the casual network the mean duration is roughly 3 months too long. There are a few possible reasons that there may be a mismatch between the formation and dissolution coefficients in-simulation that may contribute to these outcomes. Here we explore possible issues related to the window of observation for each node in the simulation and how that inluences the observable mean relationship duration. 

```{r edcalcs, echo=F, cache=T}
dur <- dat[[1]]$meandurs[1,1]
rate <- 1/dur
# randomly generate 1000
n <- 100000
r <- rexp(n, rate)
r <- sort(r)
# density function
d <- dexp(r, rate)
data <- cbind(r, d)

# which values fall outide of time window? aka impossible to observe in our simulation
window <- 30*(365/7)
newR <- r[which(r < window)]
#newD <- dexp(newR, rate)
newDur <- mean(newR)

# make smaller for plot
n <- 1000
r <- rexp(n, rate)
r <- sort(r)
# density function
d <- dexp(r, rate)
data <- cbind(r, d)

## version of casual for plotting
# first find mean in biggggg sample
dur <- dat[[1]]$meandurs[2,1]
rate <- 1/dur
# randomly generate 1000
r <- rexp(n, rate)
r <- sort(r)
newR <- r[which(r < window)]
newDur <- mean(newR)
# density function
n <- 1000
r <- rexp(n, rate)
d <- dexp(r, rate)
data2 <- cbind(r, d)
```

```{r plot-expdist, echo=FALSE, fig.align='center', out.width="70%", fig.cap="Predicted Distribution of Relationship Lengths and Simulation Window", cache=T}
dist1 <- ggplot(as.data.frame(data), aes(x=r, y=d)) +
  geom_point() +
  geom_vline(xintercept=window) +
  xlab("Relationship Length: Marriage/Cohab, Weeks") + ylab("Density") +
  geom_text(aes(x=1620, label="max obs. window", y=.0012), colour="darkblue", angle=90) +
  geom_text(aes(x=2500, label="mean = ~413 weeks", y=.00115), colour="darkblue", angle=0)

dist2 <- ggplot(as.data.frame(data2), aes(x=r, y=d)) +
  geom_point() +
  geom_vline(xintercept=window) +
  xlab("Relationship Length:Casual, Weeks") + ylab("Density") +
  geom_text(aes(x=1590, label="max obs. window", y=.005), colour="darkblue", angle=90) +
  geom_text(aes(x=750, label="mean = ~94.75 weeks", y=.0045), colour="darkblue", angle=0)

grid.arrange(dist1, dist2, ncol=1)
```

[will need to re-frame this section if the survival analysis doesn't happen until chapter 2]  

From our survival analysis it is clear that the exponential distribution, even when separated into separate networks by relationship type, had some serious limitations in its ability to represent the full distribution of relationship lengths - both by age and across the whole population. One of the limitations that may pertain to the right tail of the distribution. An exponential distribution with a mean of roughly `r round(dur)` weeks (the mean cross-sectional length in the empirical data) has a very long right tail extending beyond a normal human lifespan, `r round(max(r)/52)` years. Clearly this tail isn't possible to observe, even less so when you consider that the window of observation in the simulation is equal to the age range of the population, 15-45 (30 years). \@ref(fig:plot-expdist) shows the density plot of relationships lengths that are exponentially distributed with a mean of `r round(dur)` weeks. While `r round((length(newR)/length(r))*100, 2)`% of observsations lay within the simulation window, the removal of the tail lowers the mean observerable relationship length based on this distribution (the mean of relationship lengths if you remove the observations that are impossible to occur in the simulation) from `r round(dur)` weeks to `r round(newDur)` weeks. The mean relationship duration in the casual network is also shown to demonstrate that the simulation window of each node is unlikely to contribute to the variation we see in the mean simulated relationship duration in the same way and as such we will only implment a correction for the marriage network. 

In this scenario, we increase the edges formation coefficient by the difference between the log odds of the target mean duration and the log odds of the observable mean duration in the marriage network. If you recall, this in effect slightly alters the "edapprox" approximation method described above from adjusting the static edges coefficient by the maximum observable mean duration rather than the rather than the target mean. We hope that this wil help edges to form on average earlier in the lifecourse and help us recover missing edges. 

While not fully considered here, this issue could also be exacerbated by the fact that the mean age of marriage/cohab formation is so much later than the mean age in the casual network. When relationships form earlier on in the life cycle, the average duration is less curtailed by the age boundary of the simulation. So in addition to being much shorter than marriages and cohabitations, and the obverall expected distribution is less influenced by the obvservation window, the representation of casual relationships also benefit from their unique distribution.  


```{r scen4-tab, echo=F, cache=T}
means4 <- cbind(dat[[4]]$meandegs, dat[[4]]$meandurs)
kable(means4, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Edapprox Correction") %>%
  kable_styling(full_width=F)
```


```{r scen4-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Edapprox Correction", cache=T}
m2 <- as.data.frame(dat[[4]]$marcoh)
c2 <- as.data.frame(dat[[4]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Edapprox", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Edapprox", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Edapprox Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Edapprox Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

**Results**  
The boost in the edges coefficient sucessfully increased the overall mean degree of the network to within 2% of the target mean degree. However, very little of the increase in mean degree came from the an increase in the younger ages. Instead, the boost largely only increase the degree at the peak, which was already over-representing relationships in the mid-to-late 30s. Additionally, we only gained about two months in mean relationship duration. This is again likely due to the increase in mean degree in individuals in their 30s rather than across the network more evenly. 

## Departure 

In this scenario, I re-consider the standard implemented departure correction. As stated earlier, this correction acts to balance out the "unexpected" edge dissolutions due to aging out of the simulation or age-specific mortality by lowering the probability of "expected" edge dissolution and thereby increasing the "expected" duration of relationships. In the past this correction has been the same for both main (marriage/cohab) and casual partnerships. However, due to the large difference in the likelihood that a nodal departure causes an edge to dissolve between the networks, it is not clear that this correction 
*should* be same. 

The current correction is calculated by adding the likelihood that any one node departs the network due to aging out multiplied by the mean weighted age category-specific mortality rate per time step:  
$$drate = \frac{1}{simulation window} + ASMR_weighted$$  

The new correction represents the likelihood that if a node departs, it also dissolves a edge. 
$$1-sum(S*D*P)$$ where  
$S$ is the vector of survival by age category due to aging out  
$D$ is the vector of age category specific mortality, and   
$P$ is the vector containing the proportional mean degree in each network by age category    

This results in an estimate for the marriahe/cohab network not too far from the original correction, but a much smaller correction for the casual network. This makes sense given the very low mean degree at the oldest ages.    


```{r departure-tab, echo=F, cache=T}
drates <- cbind(dat[[1]]$nwparam[[1]]$coef.diss$d.rate, dat[[5]]$nwparam[[1]]$coef.diss$d.rate, dat[[5]]$nwparam[[2]]$coef.diss$d.rate)

kable(drates, col.names = c("Original Mortality Rate", "Updated Marriage Rate", "Updated Casual Rate"), booktabs=T, caption = "Original and Updated Mortality Rates") %>%
  kable_styling(full_width=F)
```

  
**Results**
You should notice that the mean degree of the casual network was lowered by the implementation of this departure correction. However this doesn't mean that we're not on the right track. Instead, look to the mean relationship duration. Because we are no longer overcorrecting for the number of relationships lost to the age boundary, the endogenous expectation of relationship duration is not too long and the cross-sectional mean duration hits the target. The decrease in mean degree is likely due to these relationships that don't last artifically long. The marriage network has also experienced some good improvements. The overall mean degree is now on target, and although the mean relationship duration is still too low, it has increased by almost half a year. However, we can see by the distribution of mean degree by age in both networks that much of the missing relationships are still in the youngest ages. We will focus on this problem in the next section.  

```{r scen5-tab, echo=F, cache=T}
means5 <- cbind(dat[[5]]$meandegs, dat[[5]]$meandurs)
kable(means5, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Edapprox + Mortality Corrections") %>%
  kable_styling(full_width=F)
```

```{r scen5-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Departure Corrections.", cache=T}
m2 <- as.data.frame(dat[[5]]$marcoh)
c2 <- as.data.frame(dat[[5]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("E+M", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("E+M", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Ed + Mort Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Ed + Mort Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

## Arrival & Sexual Debut

The failure of these networks to adequately form relationships among the youngest ages is yet another form of a boundary problem. The big-picture problem is that 15-year-olds do not enter the population and bring in existing relationships. This creates a problem for the model because the coefficients by age represent the prevalence of relationships at each those ages, and based on these coefficients and the underlying network the algorithm makes and breaks a certain amount of relationships at each time step. It doesn't however, expect to have to form *all* of the relationships among 15-year olds almost *immediately* up on entry, which needs to happen 1) to meet the expected mean degree, and 2) in the presence of aging when there is a very limited window to hit that age target. This also makes large jumps in the expected mean degree challenging, like in the marriage network between age 18 and 25 or in the casual network between ages 15-20. In this section we test two possible approaches to this problem. The first involves manipulating the number of individuals eligible for relationships based on the sexual debut process, and the second takes a more direct approach to manually calibrate the formation coefficients at certain ages to boost the rate of formation beyond what the ERGM initially estimated.  

I am going to contextualize our scenarios and results in two ways. First, in the ability to represent the mean degree distribution from the data (the cross-sectional relationship landscape) and second, in the accuracy of the in-simulation debut rates (i.e. who actually forms a partner at any point in the simulation) - (the longitudinal landscape). Note that the STERGM methods were developed to maintain certain cross-sectional statistics so the longtitudnal correctness isn't the primary goal, but it is important to think about when considering the broader context.  

### Sexual Debut 

[parts of this section too wordy / possibly not necessary]  
Representing the sexual debut process is both complex and highly important if we wish to model sexually transmitted diseases in adolesents and young adults. In the U.S., more than 50% of all sexually transmitted bacterial infections such as chlamydia and gonorrhea diagnosed yearly occur among individuals aged 15-24, but not everyone in the age group are sexually active, which concentrates the transmissions into subset of the population and increases the probability of exposure to an STI for those sexually active moreso than at older ages. It is important then, to approximate this process in simulation as faithfully as possible. If too many individuals are able to form sexual partnerships in the model, we risk under-estimating the risk of exposure for those sexually active and conversely over-estimating the risk of exposure if too few are sexually active.  

The process by which individuals are labled as "sexually debuted" and thus eligible to form relationships in the model is reasonably straightforward. Individuls enter the model with a 10.6% probability of debut, based on the proportion of 15 year olds in the NSFG who reported having sexual intercourse with a member for the opposite sex prior to age 15. For the rest of the age distribtion (15-44), we used the responses to "have you ever had sexual intercourse with a member of the opposite sex" to generate a cross-section distribution of sexual debut status. From this data we estimated the yearly probability of debut among those who had not, and converted that into a weekly probability. The empirical data and the in-simulation distribution of sexual debut from the base model scenario are shown in \@ref(fig:debut-table).  

```{r debut-table, echo=FALSE, fig.align='center', out.width="70%", fig.cap="Sexual Debut Status: NSFG vs Simulation"}
ages <- 15:44

# cross-sectional debut status
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# debut dist from base sim 
sim_debut  <- dat[[1]]$debut*100

debut <- as.data.frame(cbind(ages, data_debut_cs, sim_debut))
colnames(debut) <- c("Age", "Data", "Sim")
debut <- gather(debut, key="Type", value = "Debut", -Age)

ggplot(debut, aes(x=Age, y=Debut, col=Type)) +
  geom_point()
```

The major caveat to this approach is that it does not mechanistically represent the debut process as well as desired . In real life, a person "debuts" by entering into a sexual partnership. This puts the model in a bit of a catch-22 situation: an individual can't debut in real life until they form a sexual partnership, but in order to form a sexual partnership in the model, they must already be "debuted". We can match the distribution of sexually debuted individuals, but it is possible that the number of individiduals who have "debuted" does not equal the number of individuals who have actually formed a relationship at any point in the simulation.

What if instead we used the "debut" term to model the idea of "sexual eligibility" rather than explictly debut? The concept is straightforward: in most cases, an individual would decide that they are *ready* to begin having sex some period of time prior to actually forming a sexual partnership (or transitioning a relationship from a non-sexual partnership to a sexual one). It is perhaps this underlying trait that we should model instead, allowing us to model the sexual history of individuals in our model more completely. Unfortunately our survey data don't allow us to answer this question directly (i.e. at what age did you decide you were ready for sex vs at what age did you actually start having sex), and the literature has laregly focused more on individual characteristics and within-partership dynamics that predict sexual debut rather than quantifying the time to readiness or the time from readiness to debut (cite that review paper, others).

In this scenario, we change only the probability of having sexually debuted at entry so that the *effective* debut in simulation matches the proporion of 15 year olds who report having had sexual intercourse. We call this the "eligbility" scenario. All other parameters (i.e. the rate at which debut occurs among the non-debuted) remain the same. As a reminder, in this model setup, the rate of sexual debut does not influence the birth/arrival rate in the model. Eligibilty status however does dictate whether an individual is allowed to form a relationship, and the number of un-debuted persons was jointly estimated in the model, so deviations from the original distribution of eligible individuals will influence the likelihood of tie formation. 

*Results*  

The switch to an "eligibility" metric had some dramatic effects on the casual network and moderate effects on the marriage/cohabitation network. In the marriage network, the overall mean degree has increased to  about 7% greater than the target, and although we do see increases in the mean degree at younger ages that almost matches the targets, once again, the majority of the degree increase is seen between ages 30-40. The increase in the number of relationships that begin at earlier ages has increased the mean relationship length by roughly one year, but we still fall far short of the target. In the casual network, the increase in available egos for casual relationships has led to an incredible increase both the overall mean degree and in the mean degree in the under-30 population. The mean relationship duration in this network has stayed wihtin 1% of the target, which is good, but wildly over-represents the total number of relationship at most ages. This scenario will come the closest to reproducing the actual debut distbution of the data (\@ref(fig:effective-debut-comparison)), but largely at the expense of the casual network's degree distribution.  

```{r scen6-tab, echo=F, cache=T}
means6 <- cbind(dat[[6]]$meandegs, dat[[6]]$meandurs)
kable(means6, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Expanded Eligibility") %>%
  kable_styling(full_width=F)
```

```{r scen6-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Eligibility.", cache=T}
m2 <- as.data.frame(dat[[6]]$marcoh)
c2 <- as.data.frame(dat[[6]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Eligibility", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Eligibility", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Eligibility Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Eligibility Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


### Young Age Formation Boost  

In this scenario, we change none of the sexual debut parameters in leiu of adding a nodefactor term for "young persons" in each network and manually modifying 1) the degree of increase in formation, or the "boost", and 2) which ages the boost applies to in each network. This was manually calibrated by trial and error.

There's probably more I can say here.  

```{r youngboost-tab, echo=F, cache=T}
means7 <- cbind(dat[[7]]$meandegs, dat[[7]]$meandurs)
kable(means7, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Young Formation Boost") %>%
  kable_styling(full_width=F)
```

```{r youngboost-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Young Age Formation Boost.", cache=T}
m2 <- as.data.frame(dat[[7]]$marcoh)
c2 <- as.data.frame(dat[[7]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("E+M", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("E+M", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Boosted Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Boosted Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


```{r effective-debut-comparison, echo=F, fig.align="center", fig.cap="Percent Debuted In-Sim vs Data, Various Scenarios", out.width="80%"}
ages <- 15:44
# calibrated eligibility
eff_deb_calib <- dat[[6]]$effdebut*100

# from 10_1560 debut tracking sim
eff_deb_og <-  c(0.009363789, 0.058941781, 0.143552769, 0.240848193, 0.342852143, 0.434738607, 0.516314476, 0.594444046, 0.667909422, 0.728130341, 0.776367836, 0.820359054, 0.859432090, 0.883728213, 0.910764401, 0.927208922, 0.940291619, 0.947551619, 0.957545890, 0.962237502, 0.967736873, 0.969386924, 0.973694229, 0.973994443, 0.973894251, 0.975585668, 0.975469400, 0.978392997, 0.978194968, 0.980508975)*100

# cross-sectional debut status (empirical)
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# from youngboost
youngboost_deb <- dat[[7]]$effdebut*100

# scenario with NO debut terms - just effective debut tracking
nodebut <- c(0.0669383, 0.1859052, 0.2767750, 0.4112038, 0.5119332, 0.5817972, 0.6477404 ,0.7087435 ,0.7698317, 0.8181818 ,0.8479064, 0.8907168 ,0.9265672 ,0.9418398, 0.9580587, 0.9682825, 0.9748391 ,0.9816303, 0.9861111 ,0.9896468 ,0.9900990, 0.9859155,0.9951865 ,0.9981297 ,0.9951691 ,0.9969679, 0.9993846, 0.9994114 ,0.9994001, 0.9993675)*100

debut2 <- as.data.frame(cbind(ages, data_debut_cs, eff_deb_calib, eff_deb_og, youngboost_deb, nodebut))
colnames(debut2) <- c("Age", "Data (NSFG)", "Eligibility", "Default", "Default + Young Boost", "No Debut Term")
debut2 <- gather(debut2, key="Data", value = "Debut", -Age)

ggplot(debut2, aes(x=Age, y=Debut, col=Data)) +
  geom_point(aes(shape=Data), size=2.5) +
  theme(legend.position = c(.75, .45)) +
  scale_color_stata() +
  ylab("Percent Sexually Debuted")
```

*Results*  

- yay mean degree marches through age 25 in the marriage network and through age 20 in the casual network!  
- still have problem with over-boosted middle ages and as a result have too high overall mean degree  
- but 413 is the mean relationship duration we expect based on an exponential distribution w/ mean 474 with the right tail missing, so I actually think we're doing great here  
- effective debut better than default run but not as good as "eligibility" aka trade off between cross-sectional correctness (mean degree) and longitudinal in some cases. Need to think through what this means for the concentration of disease at younger ages more.  
- also effective debut not better than simulation with no debut term or process at all LOL  


### Summary & Discussion

```{r summary-degs, echo=F}
degstab <- cbind(dat[[1]]$meandegs[,1:2], dat[[2]]$meandegs[,2], dat[[3]]$meandegs[,2],
                 dat[[4]]$meandegs[,2], dat[[5]]$meandegs[,2], dat[[6]]$meandegs[,2],
                 dat[[7]]$meandegs[,2])

colnames(degstab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure", "Increased Eligibility", "Young Age Boost")
kable(degstab, booktabs=T, caption = "Mean Degree Comparison Summary Table") %>%
  kable_styling(full_width=F) %>%
  column_spec(1:9, width = "1.6cm")
```

```{r summary-durs, echo=F}
durstab <- cbind(dat[[1]]$meandurs[,1:2], dat[[2]]$meandurs[,2], dat[[3]]$meandurs[,2],
                 dat[[4]]$meandurs[,2], dat[[5]]$meandurs[,2], dat[[6]]$meandurs[,2],
                 dat[[7]]$meandurs[,2])

colnames(durstab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure", "Increased Eligibility", "Young Age Boost")
kable(durstab, booktabs=T, caption = "Mean Relationship Duration Comparison Summary Table") %>%
  kable_styling(full_width=F) %>%
  column_spec(1:9, width = "1.6cm")
```


 - no a one-size-fits-all solution
 - increased age boundary has some upsides but need to think more through that the actual mean degree target is at that point
 - edapprox correction probably not necessary if we're just going to boost some coefs later anyway
 - may be other ways to calculate the departure correction but I think this is on the right track 
 - still concerned about who in the population is sexually active and the under/overestimate of exposure risk
 - simulation with no debut term (shown in \@ref(fig:effective-debut-comparison)) shows that not having a debut term has basically the same results for effective debut as the the young boost scenario, so it's not necessarily even worth having a debut term in the model (yay? oof?)  
 - several of these approachs have clear upsides and downsides but I think boosting the coefs, and then negatively boosting coefs at older ages might be the best way forward 

**future work**
  * cross-network terms - probably going to do most analysis on the independent networks but will show both and point at where there are holes (hey by the time this gets finished maybe Chad will have already figured this out)  
  * need to think about race and sex differences in formation and absdiff(age) by sex if we want to use this for applied work  
