# Demography and Dynamic Network Simulations {#nets}

```{r libs-ch1, echo=F, message=F, warning=F}
library(ddaf)
library(tidyverse)
library(here)
library(kableExtra)
library(EpiModel)
library(ggthemes)
library(gridExtra)

alphaBlue <- rgb(red=52, blue=102, green=0, alpha=120, maxColorValue=255)
alphaGreen <- rgb(red=0, blue=0, green=102, alpha=120, maxColorValue=255)
```
*Note:*
The introduction chapter will introduce mathematical models, ergms/stergms, broadly why social scientists are interested in them, epidemics, and the primary source of empirical data (National Survey of Family Growth).  



The choice of model terms in mathematical models depends on the question of interest and the underlying patterns in the data and this is no less true for network models of sexual partnerships developed to understand disease transmission. Several previously published models using ERGMs and EpiModel to simulate epidemics focused on adult men who have sex with men (MSM) populations aged 18-39 (@Jenness2017, @Goodreau2017). These models focused on terms related to the average number of relationships of certain types, mixing patterns by age, the likelihood of concurrent partnerships. Because prevalence of both main and casual relationships remained relatively stable over the small age range, the models did not include terms that used age as a predictor of relationship formation. However, in this project, we focus on heterosexual relationships over a larger age range (15-45). Unlike the MSM models, there are large differences in the prevalence of different relationship types over this age range, so we will need to include terms that involve age in our model (see Figure \@ref(fig:diagnostic-results)). However, while individual age is straightforward to represent in this modeling framework, using age-dependent relational formation terms introduces several complicating factors for network models largely related to the boundaries imposed by age range and the aging process. In this chapter, first I will demonstrate that the dynamic networks estimated from empirical data (STERGMs, separable temporal exponential random graph models) reproduce key network statistics in the absence of dynamic vital processes. Then I will document how simulations that incorporate individual births, deaths, aging, and sexual debut lead the network to deviate from these key statistics. Third, I will explore the possible underlying causes for these deviations, implement new and/or extend existing corrections for demographic effects, evaluate the efficacy of each, and outline some possible future directions for improved simulations.

## Some Definitions  
*Node / Ego:* An individual in the network.  
*Nodal Attribute:* A trait of an individual (sex, age, sexual debut status, etc).

## Base Model Overview

The models used in this chapter focus largely on the age-related effects of relationship formation, with several additional terms and structural offsets. Two networks are estimated separately and simulated together to represent two primary categories of relationships: main partnerships defined as marriages and cohabitations, and casual partnerships, defined as any relationship with duration greater than one week that is not a marriage or cohabitations. One-off relationships ("instantaneous" or "one night stands") are not included in the current model, but will be included in later chapters when we model the transmission of disease. Both the marriage/cohabitation network and the casual networks have terms for:  
1. the overall density of the network,  
2. the prevalence of relationships by age and age-squared of each node,  
3. a mixing term for the difference in the square root of each node's age and that of their partner's age,  
4. an offset term prohibiting the formation of relationships among specific nodes to mimic the sexual debut process, and  
5. an additional offset term to prohibit the formation of relationships among same-sex nodes.  

The marriage/cohab network additionally includes a term for the number of relationships that can form among individuals who have a concurrent casual relationship as well as a term prohibiting concurrent marriages. Similarly, the casual network also includes a term for the number of individuals who have both a casual relationship and a marriage/cohabitation, as well as a term for how many relationships within the casual network exist concurrently (have one node in common). The models are estimated from egocentrically collected data (NSFG) using the ergm.ego package in R, which first estimates target statistics for the specified model terms from the data and then fits the ergms based on these targets (@Krivitsky2017). Table \@ref(tab:display-models) displays the formation models and their estimated coefficients.  

```{r display-models, message=F, warning=F, echo=F, cache=T}
library(broom)
fit.other <- readRDS(here("data", "og_fits", "fit.other.rds"))
fit.marcoh <- readRDS(here("data", "og_fits", "fit.marcoh.rds"))

fits <- rbind(tidy(fit.other), tidy(fit.marcoh))

kable(fits, booktabs=T, col.names = c("Model Term", "Estimate", "SE", "Statistic", "Pvalue"),
      caption="Summary of Formation Model Fits ") %>%
  kable_styling() %>%
    pack_rows("Casual Network", 1,9) %>%
    pack_rows("Marriage/Cohabitation Network", 10, 18)
```

## Closed-System Dynamics  

First we demonstrate that the estimated models dynamically reproduce statistics we are interested in, particularly the mean degree by age in each network and the expected duration of relationships, in a closed system (i.e. without aging, births, or deaths). This is one of the several steps to check model performance prior to epidemic simulations (for additional model diagnostics, see appendix). In this diagnostic, we simulate the STERGM for 5 repetitions of 7500 time steps (representing almost 150 years) and evaluate the cross-sectional network statistics over time. At each time step, ties can form and ties can dissolve based on the model coefficients. If the model is estimated properly and sufficient MCMC intervals are used, the network formation statistics should hover around their estimated targets. In this diagnostic we also evaluate the duration of ties and the rate of tie dissolution to ensure the dissolution targets are met. At this step, the node set is static - all nodal attributes including age are fixed, no nodes exit, and no new nodes enter the population.  

```{r diagnostic-results, echo=FALSE, out.width="60%", fig.cap="Comparison: Egodata vs Diagnostic Mean Degree.", fig.align='center', cache=T}
egodat <- egodata_meandegs()

md <- readRDS(here("data", "diagnostics", "dynamic.m.nocross.rds"))
cd <- readRDS(here("data", "diagnostics", "dynamic.c.nocross.rds"))

age <- md$nw %v% "age"
age_dist <- table(age)
m_el <- as.edgelist(md$nw)
m_age <- age[m_el]
m_agedist <- table(m_age)
m_meandeg <- m_agedist/age_dist

c_el <- as.edgelist(cd$nw)
c_age <- age[c_el]
c_agedist <- table(c_age)
c_meandeg <- c_agedist/age_dist

m_mean <- round(mean(m_meandeg),3)
c_mean <- round(mean(c_meandeg),3)

datdiag <- cbind(15:44, egodat[[1]][,2], as.numeric(m_meandeg), egodat[[3]][,2], as.numeric(c_meandeg))
colnames(datdiag) <- c("Ego Age", "Data: Marriage/Cohab", "Net Dx: Marriage/Cohab", "Data: Casual", "Net Dx: Casual")
datdiag <- gather(datdiag, Type, `Mean Degree`, -`Ego Age`)

ggplot() +
  geom_point(data=datdiag, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

```{r dynamic-duration-m, echo=F, fig.align='center', fig.cap="Mean Relationship Lengths in Diagnostic", out.width="60%", cache=T}
par(mfrow=c(1,2))
plot(md, type="duration", xlab="Diagnostic Time Step, Mar/Coh")
plot(cd, type="duration", xlab="Diagnostic Time Step, Casual")
```

Figures \@ref(fig:diagnostic-results) and \@ref(fig:dynamic-duration-m) show that in this closed system simulation, the models perform exceptionally well. Not only is the overall mean degree of each network met, but mean degree by age in both networks is also reproduced well, which is not necessarily guaranteed by the parsimonious parameterization - so the estimated networks are actually exceeding expectations. Additionally, both models reach the target mean cross-sectional relationship duration after sufficient time. Any deviation from these targets as we move to the simulation then, should be related to the introduction of vital dynamics and other processes like sexual debut.  

## Existing Demographic corrections

This section provides an overview of existing corrections for dynamic networks and demography and outlines some of the boundary effect issues that we will explore in more detail below.

**1. Formation Approximation**  
In many cases, a full STERGM cannot directly be estimated directly due to the computational burden when networks are large, sparse, and have relatively long relational durations (which describes many sexual networks). Instead @Carnegie2015 introduced an approximation to full STERGM estimation that uses the same data: cross-sectional egocentric network data and information on tie duration. In this approximation, the static ERGM is estimated using standard techniques. Then the edges formation term (which represents the base propensity for ties to form between any two individuals in the network) is decreased by the log odds of the probability of edge persistence, in effect transforming the formation term from *prevalence* of ties in the network to the *incidence* of ties. The explorations below do not attempt to modify this approach, but instead explore the relationship between the adjustment of the formation coefficient, the probability of tie persistence as estimated from the long relationship duration expected in the marriage network relative to the limited observation window per individual as they arrive and eventually age out.  

**2. Departure Correction**  
The node departure correction used in the model estimation-to-simulation workflow is necessary due to the observation that when nodes were removed from the simulation to mimic, for example, background age-specific mortality, the mean degree of the network became lower than expected, as does the mean duration of relationships. The logic is relatively straightforward: the statistical model underlying these network simulations balances the probability of tie formation with the probability of tie dissolution in order to maintain a target number of ties in the network. However, when nodes depart in an open population, some additional ties will break due to this process, lowering mean degree and the mean duration of ties. This node death is exogenous to the originally estimated statistical model, and therefore “unexpected”. To counter the lowering of relationship duration (and subsequently mean degree) related this excess node death, the expected (endogenous) duration of ties is increased such that the *average* duration in the presence of both forms of dissolution is maintained.  
The departure correction implemented in previous models has two components: 1) the average mortality rate per time step across the entire population (often weighted by age and/or race) and 2), the rate at which individuals depart the simulation due to the age boundary, calculated as 1/(time steps each node is expected to be observed in the simulation in the absence of early death). (cite SMG's working paper?) For example, if the age range of the model was 18:39, then the weekly rate at which each individual was expected to be exit the simulation is 1/(52*(39-18)). In the past this approach has successfully balanced the additional unexpected dissolution of relationships due to node departure. Below we will explore situations where this correction is not sufficient in its current form.  

**3. Population Size Correction**  
Occasionally it is of interest to model a population that is growing, declining, or stochastically varying around some mean size. The correction outlined in @Kritvitsky2011 makes small adjustments at each time step based on the difference in population size between time t and t-1 to the coefficient on the edges (density) term. This correction is designed to maintain the target mean degree of the network in the presence of changes in the size of the population by while preserving the odds of forming ties based on nodal attributes as specified by the other model terms (e.g. matching by age, race, classroom, etc). This correction is robust to many changes in the population size and composition, so we will not further modify it here.

## Overview of Open-Population Demographic Processes of Interest

The open-population simulations run using the EpiModel API are distinct from the above closed-system simulations in that in addition to tie formation and dissolution at every time step, a series of modules is run that govern important demographic processes: node departure, node entry, aging, and sexual debut. Nodes automatically depart the model at age 45. This boundary was selected for two main reasons: 1) According to the CDC in their 2018 surveillance report, 97.4% of all chlamydia infections were diagnoses in the 15-44 age range (@CDC2019) and 2) the National Survey of Family Growth, the empirical data from which we estimate our model, only surveys adults aged 15-44. There are likely other sources of information that we could use to increase the age range, but it did not seem necessary to our questions of interest. Note that implicit in this decision is the elimination of all reported relationships among egos aged 15-45 whose *partners* are outside of this age range. The degree distribution that we actually use to estimate the model (and are trying to maintain during simulation) looks rather different than the original distribution shown above, particularly in the marriage/cohabitation network (see \@ref(fig:egodata-2)). We will consider the consequences of this in a later section.

In addition to the age boundary at 45, all individuals experience the possibility of dying at each time step. I will refer to this as their age-specific mortality rate, or ASMR. Each node belongs to a class based on their 5-year-age-category and their sex, and is evaluated for death at every time step with the probability determined by data from published in recent U.S. Vital Statistics documents. Given that our age range is relatively young, departures due to background mortality are uncommon relative to the effect of the age boundary on which nodes depart the model. Nodes enter at age 15 at a rate based on the expected number of departures per time step in order to keep the population size relatively stable. Like the number of deaths due to ASMR, the actual number of entires per time step is stochastic but maintains a population size within 1-2% of the starting size of 50,000 nodes. Each time step in the simulation represents one week, so nodes age by 1/52 per time step. Nodes enter the population at age 15 and are evaluated for sexual debut at each time step, with probability that increases until age 29 to match the age-at-debut distribution as reported in the NSFG. In accordance with the data where a small proportion of the population never reports intercourse with a member of the opposite sex, some individuals will never will never "debut" and will therefore never form a tie in these networks.

## Initial Simulation Results

Unlike closed-population scenario above, when we run these simulations with demographic processes, several metrics stray from their target values. First, while the mean degree in the initial networks march the targets, the equilibrium mean degrees, or average number of relationships per person across each network, are lower than expected in both the marriage/cohabitation network and in the casual network (by roughly five and three percent respectively). These deviations are not large overall, but they are especially concerning when considering the equilibrium distribution of relationships by age. The mean degree by age is underrepresented in both networks for the youngest ages but overrepresented in the mid-30s. Finally, the mean relationship length is 24% too short in the marriage network but 7% too long in the casual network. In the next few sections, we describe possible explanations for these deviations and explore several corrections.

```{r load-simdata, echo=F}
dat <- readRDS(here("data", "summary_sims.rds"))
```

```{r scen1-tab, echo=F, cache=T}
means1 <- cbind(dat[[1]]$meandegs, dat[[1]]$meandurs)
kable(means1, col.names = c("Mean Degree Target", "Base", "Pct Off",
                                       "Mean Duration Target", "Base", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets and Base Simulation") %>%
  kable_styling(full_width=F)
```

```{r scen1-networks, echo=F, fig.align='center', fig.cap="Base Simulation: Mean Degree by Age.", cache=T, out.width="80%"}
mdat <- as.data.frame(dat[[1]]$marcoh)
cdat <- as.data.frame(dat[[1]]$casual)
m <- ggplot() +
     geom_bar(data = mdat, aes(x=`Ego Age`, y=`Final State of Network`, fill="Final State of Network"), stat = "identity", fill="#999999") +
    geom_point(mdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata - Restricted`, color="Weighted Egodata - Restricted"))  +
    geom_point(mdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata`, color="Weighted Egodata"))+
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Egodata",
                       labels = c("Weighted Egodata", "Weighted Egodata, All Alters"),
                       values = c("darkblue", "darkred")) +
  theme(legend.position = "none") + ggtitle("Marriage/Cohab") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
      geom_bar(cdat, mapping=aes(x=`Ego Age`, y=`Final State of Network`, fill="Final State of Network"), stat = "identity", fill="#999999") +
      geom_point(cdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata - Restricted`, color="Weighted Egodata - Restricted"))  +
      geom_point(cdat, mapping=aes(x=`Ego Age`, y=`Weighted Egodata`, color="Weighted Egodata"))+
      xlab("Ego Age") +
      ylab("Mean Degree") +
      scale_color_manual(name = "Egodata",
                         labels = c("Weighted Egodata", "Weighted Egodata, All Alters"),
                         values = c("darkblue", "darkred")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) + ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


## Considering the effect of older partners  
The empirical data show that the prevalence of marriages and cohabitations is higher at older ages than at younger ages, and the model coefficients support this observation (as demonstrated by the closed-system results). However, we observe that in simulations when the characteristics of the node set are largely in equilibrium but each individual node enters, ages, and eventually exits, there are too many relationships among the older egos. We theorize that this may be due to the age boundary imposed by the model. When nodes leave the simulation age at 45, they will dissolve any relationship that they were in at the previous time step. While these additional dissolutions are theoretically corrected for using the Departure Correction, the positive model coefficient on age and prohibition on concurrency suggest that the now-unpartnered node who remains in the simulation after their partner departs has a high likelihood of forming a new relationship. And because the age-mixing term increases the odds of forming relationships with nodes of similar ages, the incidence of relationships at older ages increases. It is possible that these new, short relationships in older ages contribute both to the lower than expected mean relationship duration in the marriage network and the lower than expected mean degree at younger ages. The problem is that the tie that dissolved as a result of one partner leaving the simulation due to this age boundary is not a true dissolution, and these newly formed relationships should not actually exist because the remaining partner should not actually be eligible to form a new relationship in the network yet. That is, they should still be in their original relationship, even if we no longer observe it. Figure \@ref(fig:egodata-2) highlights this age boundary effect in the empirical data. The light blue and light red dots reflect the mean degree by age among egos and their partners aged 15-44. Their darker counterparts reflect egos reporting on their partners of all ages. The effect is particularly pronounced among the oldest ages in the marriage network, while there is a much smaller effect in the casual network. The casual network also displays some small differences in the youngest ages, where a few 15 and 16 year-olds report relationships with partners younger than 15, although the below corrections focus only on correcting for the effect of partners outside the upper end of the age boundary.  

```{r egodata-2, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Mean Degree by Ego Age and Relationship Type, Restricted and Unrestricted Alters", cache=T}
egoplotdat <- cbind(egodat[[2]][,1:2], egodat[[1]][,2], egodat[[4]][,2], egodat[[3]][,2])
names(egoplotdat) <- c("Ego Age", "Marriage/Cohab", "Marriage/Cohab - Restricted", "Casual", "Casual - Restricted")
egoplotdat <-  gather(egoplotdat, Type, `Mean Degree`, -`Ego Age`)
ggplot() +
  geom_point(data=egoplotdat, aes(x=`Ego Age`, y=`Mean Degree`, color=Type)) +
  theme(legend.position = c(0.16, 0.8)) +
  scale_color_manual(values=c("darkblue", "blue", "darkred", "red"))
```

We consider two ways to address the effect of partners outside the age boundary. First, we prevent egos whose partners have aged out from immediately forming new relationships by adding an offset term for egos who meet this condition. In this scenario we hope that by preventing new relationships from forming among egos whose previous relationships were terminated artificially by the age boundary, the simulation will better match the data with the restricted alter set and increase the mean relationship length by generating new relationships at earlier ages. In the second scenario, we increase the age at which egos depart the simulation to age 65. While we may not be interested in modeling individuals older than 44 for epidemiological reasons, it may be worthwhile to keep them in the simulation over a longer period of time to avoid the artificial ending of relationships. In this case we hope to match the empirical mean degree distribution among egos with the age-unrestricted alter set. However, because we would be simulating individuals outside the age range in the data we used for estimation, we may run into additional issues.

### Offset for Partner Age-Out

This scenario adds an offset term to the formation model (“olderpartner”) for egos whose alters are outside of the 15-44 age range modeled in the simulation. We have a target count for this offset during estimation because as the figure above demonstrates, there are nodes that exist in the empirical data who have a partner older than 44. During the simulation, if a node ages out while they are in a relationship, the remaining partner gets flagged by the “olderpartner” attribute and are prohibited from forming a new relationship. The probability of becoming available for a relationship on any future time step (i.e. removing the "olderpartner" flag by resetting that attribute to 0) is equal to 1/expected duration of the relationship type, although in the case of the marriage/cohabitation network relationships last so long that it is unlikely that a node becomes available for the rest of their simulation life-course (unless the age difference between partners was exceptionally large, which is not impossible). Figure \@ref(fig:scen2-networks) plots the mean degree by age in the simulation with the older partner offset included compared to both the base model simulation and the egodata. The first thing we note is that this offset did not largely influence the overall mean degree in either network, nor did it increase the mean relationship duration in the marriage/cohabitation network (mean relationship length was also unchanged in the casual network, but we did not necessarily expect it to). When comparing mean degree by age between scenarios, the offset did not correct the general trend of the overrepresentation of relationships at the older ages, but it did slightly increase the mean degree in nodes ages roughly 30-35. The casual network was largely uninfluenced by this offset.

```{r scen2-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Base vs Offset.", cache=T}
#```{r scen2-tab, echo=F, cache=T}
#```

means2 <- cbind(dat[[2]]$meandegs, dat[[2]]$meandurs)

kable(means2, col.names = c("Mean Degree Target", "Base", "Pct Off",
                                       "Mean Duration Target", "Base", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Older Partner Offset") %>%
  kable_styling(full_width=F)

m2 <- as.data.frame(dat[[2]]$marcoh)
c2 <- as.data.frame(dat[[2]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Offset", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Offset", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Offset Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Offset Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


#### Increase Age Boundary

In this scenario, we hope to move the degree distribution closer to the egodata distribution with the age-unrestricted alters, the distribution that better represents reality when surveying egos aged 15-44 about their relationships. This scenario also includes the offset for “older partners” but employs it in a slightly different fashion. In the previous scenario, edges dissolved artificially when one of the partners left the model at age 45. We now allow all individuals to remain in the simulation until age 65 and allow those relationships to continue as they would normally. We use the offset to prevent any nodes older than 45 from forming new relationships. This means that only relationships that began prior both partners turning 45 exist in this simulation.

Table \@ref(tab:scen3-networks) and Figure \@ref(fig:scen3-networks) present the results from this scenario. It is clear that in the marriage/cohabitation network, we can easily represent the partnerships lost to the upper age boundary simply by keeping their older partners in the model, even if the data used to estimate the model did not include these partners. However, this approach has some unintended consequences. The edges coefficient in the formation model is a density term, and its target is based on a mean degree estimated from the restricted partner data. When we prevent relationships from dissolving when one partner turns 45, we increase the mean degree of those at older ages, bu this same logic this would imply then a decrease in the mean degree at younger ages. And indeed this is what we observe: the increased age boundary reduces the mean degree of those below 30 in the casual network and those roughly 25-35 in the marriage/cohabitation network. So while the overall mean degree now slightly exceeds the target and the mean relationship length has increased, this approach on its own fails to substantially improve the fit of the mean degree distribution overall. 


```{r scen3-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Increased Age Boundary.", cache=T}
#```{r scen3-tab, echo=F, cache=T}
#```
means3 <- cbind(dat[[3]]$meandegs, dat[[3]]$meandurs)
kable(means3, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Increased Age Boundary") %>%
  kable_styling(full_width=F)

m2 <- as.data.frame(dat[[3]]$marcoh)
c2 <- as.data.frame(dat[[3]]$casual)

scen2m <- cbind(m2, mdat[,4])
colnames(scen2m)[4:5] <- c("Increased Age Boundary", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2, cdat[,4])
colnames(scen2c)[4:5] <- c("Increased Age Boundary", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Increased Age Boundary",
                                   "Weighted Egodata", "Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkred", "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Increased Age Boundary",
                                   "Weighted Egodata", "Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkred", "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

We find that these corrections that focus on the effet of older partners have limited utility on their own. That we could capture the distribution of relationships with unrestricted partner ages by a simple extension of the age boundary is heartening and may have a role to play in other contexts, but the consequences in the casual network in particular are too strong to continue down this path. The small improvements we see in mean relationship duration and mean degree in the marriage network suggest that while the older age boundary may not be the primary factor governing the misrepresentation of relationships by age, it did contribute. The fact that very little effect at all on the casual network is somewhat expected given that older ages are actually less likely to form casual partnerships than younger ages. Additionally, whereas each node is allowed a maximum of one relationship in the marriage network, no such limit exists for the casual network, so the prohibition on relationship formation in the casual network is not strictly necessary. We continue to include the older partner offset in the following scenarios because it makes intuitive sense in the marriage network to discourage partner turnover at the oldest ages due to artificial relationship dissolution. However, more work is needed to address the broader issues in these simulations.  

## Relationship Length & The Simulation Window

We now turn our focus to the issue of relationship length. So far, our attempts to represent relationships at older ages in a more accurate way has not corrected the issues with relationship duration in these networks. In the marriage/cohabitation network, the mean relationship length falls nearly 2 years short of the target length and the length among casual relationships is roughly 10% too long. This may not seem substantial, but these shorter, occasionally overlapping, relationships are important for the transmission of STIs and an increase in the mean length (and poentially decreasing the rate of new partner acquisition) could have consequences for our understanding of epidemics across these networks (@Morris2009, @Niccolai2005, @Jolly2001). Conversely, marriages that are too short may decrease the time certain portions of the network are isolated and protected from exposure. There are a few possible reasons that there may be a mismatch between the formation and dissolution coefficients in-simulation that may contribute to these outcomes. Here we explore a possible issue related to the window of observation for each node in the simulation and how that influences the observable mean relationship duration.  

The dissolution component of the STERGM in these models assumes a homogenous (exponential) hazard of dissolution within each network (i.e. marriages and casual relationships have different expected duration, but *each* marriage has the same expected length). The model then evaluates each relationship at every time step for stochastic dissolution, and this generates a distribution of simulated relationship lengths within each network that is exponential. There are consequences of this assumption of a constant hazard that we explore in greater detail in Chapter 2, but for now we will address the relationship between the range of possible relationship lengths predicted by the exponential and the length of the simulation window that we are actually able to observe in the simulation.  

```{r plot-expdist, echo=FALSE, fig.align='center', out.width="70%", fig.cap="Predicted Distribution of Relationship Lengths and Simulation Window"}
dur <- dat[[1]]$meandurs[1,1]
rate <- 1/dur
# randomly generate 1000
n <- 1000
r <- rexp(n, rate)
r <- sort(r)
# density function
d <- dexp(r, rate)
data <- cbind(r, d)

# which values fall outide of time window? aka impossible to observe in our simulation
window <- 30*(365/7)
newR <- r[which(r < window)]
#newD <- dexp(newR, rate)
newDur <- mean(newR)

## version of casual for plotting
# first find mean in biggggg sample
dur2 <- dat[[1]]$meandurs[2,1]
rate2 <- 1/dur2
# randomly generate 1000
r2 <- rexp(n, rate2)
r2 <- sort(r2)
newR2 <- r2[which(r2 < window)]
newDur2 <- mean(newR)
# density function
n <- 1000
r2 <- rexp(n, rate2)
d2 <- dexp(r2, rate2)
data2 <- cbind(r2, d2)

dist1 <- ggplot(as.data.frame(data), aes(x=r, y=d)) +
  geom_point() +
  geom_vline(xintercept=window) +
  xlab("Relationship Length: Marriage/Cohab, Weeks") + ylab("Density") +
  geom_text(aes(x=1620, label="max obs. window", y=.0012), colour="darkblue", angle=90) +
  geom_text(aes(x=2500, label="mean = ~413 weeks", y=.00115), colour="darkblue", angle=0)

dist2 <- ggplot(as.data.frame(data2), aes(x=r, y=d)) +
  geom_point() +
  geom_vline(xintercept=window) +
  xlab("Relationship Length:Casual, Weeks") + ylab("Density") +
  geom_text(aes(x=1590, label="max obs. window", y=.005), colour="darkblue", angle=90) +
  geom_text(aes(x=750, label="mean = ~94.75 weeks", y=.0045), colour="darkblue", angle=0)

grid.arrange(dist1, dist2, ncol=1)
```

An exponential distribution with a mean of roughly `r round(dur)` weeks (the mean cross-sectional length of marriages in this data) has a very long right tail extending to `r round(max(r)/52)` years. Clearly this tail is not possible to observe when you consider that the window of observation in the simulation is equal to the age range of the population, 15-44 (30 years). \@ref(fig:plot-expdist) shows the density plot of 1000 relationships lengths that are randomly generated from an exponential distribution with a mean of `r round(dur)` weeks based on the data for marriages and cohabitations, and `r round(dur2)` weeks for the casual. While `r round((length(newR)/length(r))*100, 2)`% of randomly generated marriages lay within the simulation window, the removal of the tail lowers the mean observable relationship length based on this distribution (the mean of relationship lengths if you remove the observations that are impossible to occur in the simulation) from `r round(dur)` weeks to `r round(newDur)` weeks. The mean relationship duration in the casual network is also shown to demonstrate that the simulation window of each node is unlikely to contribute to the variation we see in the mean simulated relationship duration in the same way and as such we will only implement a correction for the marriage network.

Recall the previous description of the formation approximation that used log of the expected relationship duration to convert the edges coefficient estimated by a static ERGM from a prevalence term to an incidence term for a dynamic network. In the present scenario, we modify this approximation for the marriage/cohabitation. Instead of using the log of the target duration, we instead use use the log of the mean relationship length that we estimate from the distribution that was truncated by the simulation window length. This will slightly increase the underlying rate of formation in the network and hopefully will both help us recover missing edges across the network but specifically increase the number of edges that form earlier in the life-course, improving our fit of the full mean degree distribution and increasing the mean observed relationship length.  

```{r scen4-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Edapprox Correction", cache=T}
means4 <- cbind(dat[[4]]$meandegs, dat[[4]]$meandurs)
kable(means4, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Edapprox Correction") %>%
  kable_styling(full_width=F)

m2 <- as.data.frame(dat[[4]]$marcoh)
c2 <- as.data.frame(dat[[4]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Edapprox", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Edapprox", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Edapprox Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Edapprox Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

The boost in the edges coefficient successfully increased the overall mean degree of the network to within 2% of the target mean degree. However, very little of the increase in mean degree came from an increase relationship prevalence at younger ages. Instead, the boost largely only increased the degree at the peak, which was already over-representing relationships in the mid-to-late 30s. Additionally, we only gained about two months in mean relationship duration. This is again likely due to the increase in mean degree in individuals in their 30s rather than across the network more evenly. If more relationships had formed among younger individuals, more relationships would have the opportunity to last longer, improving mean length. Unfortunately while this is a step in the right direction, it is becoming clear that in order to meet the target mean degree in both the marriage network and the casual network we will have to address the issue of formation at younger ages more directly. In the next section we will address one more facet of the age-boundary related issues before moving our focus to the formation of edges among the younger ages.

## Departure  

The departure correction seeks to balance out the "unexpected" edge dissolutions due to nodes departing the simulation due to aging out or age-specific mortality by increasing the underlying expected length of relationships in each network (or rather, decreasing the log-odds of dissolution). The current departure correction generates a single estimate that is applied to the dissolution coefficient of both networks. When considering these marriage and casual networks among heterosexuals across a wide age range however, this assumption may not hold given the extreme variation in the prevalence of relationships by age. Most nodal departures in the simulation are due to nodes departing at age 45, but nodes of this age are far more likely to dissolve a marriage or cohabitation than a casual relationship upon departure. In this scenario, I re-consider the standard implemented departure correction by incorporating information about the prevalence of ties across likely departures.

The current correction is calculated by adding the probability that any one node departs the network due to aging out multiplied by the mean weighted age category-specific mortality rate per time step to estimate the average probability of departure for any given node in the network per time step:  
$$drate = \frac{1}{w} + ASMR_{weighted}$$ where $w$ is the number of weeks we observe each node from entry to exit in the absence of death, 1560. 

The new correction represents the likelihood that if a node departs, it also dissolves a edge.
$$1-\sum_{a=1}^{6} S_a*D_a*P_a$$ where  
$a$ = each 5-year age category labeled 1-6, representing ages 15-19...40-44  
$S$ = the survival probability for a node in a given age category due to aging out per week  
$D$ = the probability of death for a node in a given age category per week  
$P$ = mean degree of a given age category relative to the cumulative mean degree  

Table \@ref(tab:departure-tab) displays two sets of departure correction: the original departure correction (which is the same for both networks), and a second using the new formula. Notice that new estimate for the marriage network that is slightly higher than the original departure correction, this formula produces a significantly smaller departure correction for the casual network. This makes some intuitive sense given the a node departing at age 45 has roughly a 50% change of dissolving a marriage, but less than a 10% chance of dissolving a casual relationship.    

```{r departure-tab, echo=F, cache=T}
drates <- cbind(dat[[1]]$nwparam[[1]]$coef.diss$d.rate, dat[[5]]$nwparam[[1]]$coef.diss$d.rate, dat[[5]]$nwparam[[2]]$coef.diss$d.rate)

kable(drates, col.names = c("Original Mortality Rate", "Updated Marriage Rate", "Updated Casual Rate"), booktabs=T, caption = "Original and Updated Mortality Rates") %>%
  kable_styling(full_width=F)
```

The updated departure corrections improved key metrics in each network in different ways. First, the marriage network reached its target mean degree and slightly increased the mean duration of relationships. This appears to be largely due to the slight increase in the prevalence of relationships among nodes in their late-20s and a larger increase in relationships among nodes in their 30s. Once again, because this correction is not age-specific, the largest effect is seen at ages where the mean degree peaks. In the casual network, the mean relationship length has reached its target. Unfortunately, because relationships are now slightly shorter than in previous simulations, without a corresponding increase in the rate of relationship formation, the mean degree is slightly lower than before this correction. While this departure correction has strong theoretical support, it on its own is not sufficient to address all of the observed issues. We now finally turn to the issues relating to the left side of the distribution: the under-formation of ties between the ages of 15-25.  

```{r scen5-tab, echo=F, cache=T}
means5 <- cbind(dat[[5]]$meandegs, dat[[5]]$meandurs)
kable(means5, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Edapprox + Mortality Corrections") %>%
  kable_styling(full_width=F)
```

```{r scen5-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Departure Corrections.", cache=T}
m2 <- as.data.frame(dat[[5]]$marcoh)
c2 <- as.data.frame(dat[[5]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("E+M", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("E+M", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Ed + Mort Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Ed + Mort Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```

## Arrival & Sexual Debut

The failure of these networks to adequately form relationships among the youngest ages is yet another form of a boundary problem. The big-picture problem is that when 15-year-olds enter the population, they do not bring in any existing relationships. This creates a problem for the model because the formation coefficients that govern the incidence of relationships at each age 15 are not estimated with the need to form all of the *prevalent* relationships among 15-year olds almost immediately upon entry. Additionally, unlike the diagnostics that occur in the closed system with a static node set, the age of each node is now a time-varying attribute (aging). This makes large jumps in the expected mean degree by age challenging because there is a limited time frame for nodes of a certain age to form sufficient new relationships like in the marriage network between age 18 and 25 or in the casual network between ages 15-20. Essentially, the seemingly straightforward change from a static nodal attribute to a time-varying attribute means we need slightly different network conditions in order to meet the expected age-specific mean degree targets.  
In this section we test two possible approaches to this problem. The first involves manipulating the number of individuals eligible for relationships based on the sexual debut process, and the second takes a more direct approach to manually calibrate the formation coefficients at certain ages to boost the rate of formation to account for the insufficient incidence rate. In order to evaluate the efficacy of each scenario, we will consider both the effect on the cross-sectional prevalence of relationships by age as in previous sections, and additionally the proportion of individuals who ever form a relationship (sexually debuted) by age while in the simulation.

### Sexual Debut vs Readiness

Representing the sexual debut process is both complex and highly important if we wish to model sexually transmitted diseases in adolescents and young adults. In the U.S., more than 50% of all sexually transmitted bacterial infections such as chlamydia and gonorrhea diagnosed yearly occur among individuals aged 15-24, but not everyone in the age group is sexually active. This concentrates the transmissions into a subset of the population and increases the probability of exposure to an STI for those sexually active more so than at older ages. It is important then, to approximate this process in simulation as faithfully as possible. If too many individuals are able to form sexual partnerships in the model, we may under-represent the risk of exposure for those sexually active and conversely over-represent the risk of exposure if too few are sexually active.  
Here we take a moment to outline a few key definitions before describing the various possible implementations of this process.  
**1. Sexual Debut** occurs when an individual first has a sexual intercourse of any kind with a member of the opposite sex (remember, we only represent opposite-sex contacts in this project). The NSFG explicitly asks if an individual has had sexual intercourse with a member of the opposite sex, and if so, what month/year did they first have sex.  
**2. Readiness** is the state of an individual who has not yet had sexual intercourse (or "debuted"), but feels ready to do so. This state is not captured in our empirical data, but is the parameter we would ideally want to use in our dynamic networks to signal that a particular node is eligible to form a partnership. In the following scenarios we will use the nomenclature of sexual debut to model different ways we can represent readiness in these models.

For our baseline model, we assume that sexual debut and readiness are the same metric. Individuals enter the model with a 10.6% probability of debut, based on the proportion of 15 year olds in the NSFG who reported having sexual intercourse with a member for the opposite sex prior to age 15. For the rest of the age distribution, we used the responses to "have you ever had sexual intercourse with a member of the opposite sex" to generate a cross-sectional distribution of sexual debut status. From this data we estimated the weekly probability of debut among those who have not already debuted. The empirical data and the in-simulation distribution of sexual debut from the base model scenario are shown in \@ref(fig:debut-table). Unfortunately, while this approach is straightforward it also creates somewhat of a catch-22. Because an individual in our model cannot form a sexual partnership *until* they have been labeled as "debuted" by the attribute adjustment process described above, there is a lag between receiving the attribute flag of "debuted" and actually forming a partnership. So while can match the distribution of this attribute to the empirical data, the number of individuals who have truly formed a relationship for the first time in our networks is lower than the observed data, and could contribute to the ongoing issues surrounding matching the target mean degree, particularly at younger ages.

*change figure \@ref(fig:debut-table) to also show effective debut in baseline scenario*

```{r debut-table, echo=FALSE, fig.align='center', out.width="70%", fig.cap="Sexual Debut Status: NSFG vs Simulation"}
ages <- 15:44

# cross-sectional debut status
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# debut dist from base sim
sim_debut  <- dat[[1]]$debut*100

debut <- as.data.frame(cbind(ages, data_debut_cs, sim_debut))
colnames(debut) <- c("Age", "Data", "Sim")
debut <- gather(debut, key="Type", value = "Debut", -Age)

ggplot(debut, aes(x=Age, y=Debut, col=Type)) +
  geom_point()
```

In our next scenario, we to use the "debuted" nodal attribute as a signal of readiness to form a tie. Unfortunately our survey data do not allow us estimate the average time-to-debut directly (i.e. at what age did you decide you were ready for sex vs at what age did you actually start having sex), and the literature has largely focused more on individual characteristics and within-partnership dynamics that predict sexual debut rather than quantifying the time to readiness or the time from readiness to debut (@Lara2016, @Cavazos-Rehg2009, @Kaestle2002). In the absence of additional information, we instead alter only the probability of having sexually debuted at entry at age 15 such that the rate of relationship formation *in-simulation* matches the proportion of 15 year olds who report having had sexual intercourse. This calibration results in a 90% probability of sexual readiness upon entry into the simulation. We then assume that after age 15 readiness to form relationships increases at the same rate we used earlier for sexual debut. We hope that increasing the number of individuals who are available to form partnerships while maintaining the originally estimated coefficients for the rate of relationship formation will help us better match the total number of relationships expected within the younger population.

The switch to this readiness metric had some dramatic effects on the casual network and moderate effects on the marriage/cohabitation network. In the marriage network, the overall mean degree has increased to about 9% greater than the target, and although we do see increases in the mean degree at younger ages that almost matches the targets, once again, the majority of the degree increase is seen between ages 30-40. The increase in the number of relationships that begin at earlier ages has increased the mean relationship length by roughly one year, but we still fall far short of the target. In the casual network, the increase in available egos for casual relationships has led to a very large increase both the overall mean degree and in the mean degree in the under-30 population. The mean relationship duration in this network has stayed within 1% of the target, but over-represents the total number of relationship at most ages. This scenario will come the closest to reproducing the actual debut distribution of the data (\@ref(fig:effective-debut-comparison)), but largely at the expense of the casual network's degree distribution.  

```{r scen6-tab, echo=F, cache=T, out.width="70%"}
means6 <- cbind(dat[[6]]$meandegs, dat[[6]]$meandurs)
kable(means6, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Expanded Eligibility") %>%
  kable_styling(full_width=F)
```

```{r scen6-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Eligibility.", cache=T}
m2 <- as.data.frame(dat[[6]]$marcoh)
c2 <- as.data.frame(dat[[6]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("Eligibility", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("Eligibility", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Eligibility Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Eligibility Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


### Young Age Formation Boost  

In this scenario, our goal is to increase the rate of relationship formation among certain younger ages to increase the number of prevalent relationships at these ages by reducing the lag between becoming available for a sexual relationships and actually forming one. We revert the likelihood of sexual debut at entry to the baseline parameter and instead add an additional term to the network formation model in order to boost the log-odds of forming a tie among certain ages. I do so using a manual calibration process using several parameters: a formation coefficient to boost certain nodes at specific ages, and the proportion of nodes at these ages that required the boost in order to match the prevalence of relationships in the 15-25 year-old age range. The original plan for this scenario did not include the second set of parameters, we intended only to boost formation at entry to correct for the boundary issues discussed above. However, in order to match the expected degree distribution in these younger ages, we found that additional boosts among nodes who had just aged into the next integer year (i.e. recently turned 17) were necessary at certain ages where the mean degree increased rapidly year-over-year. In the casual network we applied to this additional formation probability to all nodes at age 15 for the full year they are 15, and at age 17 and 18 for the first three months they are 17 and 18. In the marriage network, this additional rate of formation was applied to all nodes at ages 18 and then again for the first three months that nodes are aged 20 and 23. (In chapter three we will apply a similar correction but will include separate formation coefficients at each age for ease of calibration which increases the number of coefficients needed to calibrate, but is more intuitive than applying the same boost to different proportions of those nodes of a certain age).  

```{r youngboost-tab, echo=F, cache=T}
means7 <- cbind(dat[[7]]$meandegs, dat[[7]]$meandurs)
kable(means7, col.names = c("Mean Degree Target", "Sim", "Pct Off",
                                       "Mean Duration Target", "Sim", "Pct Off"),
       booktabs=T,
      caption = "Mean Degree and Duration Comparison, Targets vs Young Formation Boost") %>%
  kable_styling(full_width=F)
```

```{r youngboost-networks, echo=F, fig.align='center', out.width="80%", fig.cap="Mean Degree Comparison: Young Age Formation Boost.", cache=T}
m2 <- as.data.frame(dat[[7]]$marcoh)
c2 <- as.data.frame(dat[[7]]$casual)

scen2m <- cbind(m2[,c(1:2,4)], mdat[,4])
colnames(scen2m)[3:4] <- c("E+M", "Base Sim")
scen2m <- scen2m %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

scen2c <- cbind(c2[,c(1:2,4)], cdat[,4])
colnames(scen2c)[3:4] <- c("E+M", "Base Sim")
scen2c <- scen2c %>% pivot_longer(names_to="data", values_to="value",-`Ego Age`)

m <- ggplot() +
     geom_point(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2m,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Boosted Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  ggtitle("Marriage/Cohab") +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(0,0.75))

c <- ggplot() +
     geom_point(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
       geom_line(data = scen2c,
              aes(x=`Ego Age`, y=value, col=data)) +
    xlab("Ego Age") +
    ylab("Mean Degree") +
    scale_color_manual(name = "Data",
                       labels = c( "Base Sim", "Boosted Sim","Weighted Egodata (Restr)"),
                       values = c(alphaGreen, alphaBlue, "darkblue")) +
  theme(legend.position = c(0.65, 0.88), legend.title = element_blank()) +
  ggtitle("Casual") +
  coord_cartesian(ylim=c(0,0.75))

grid.arrange(m, c, ncol=2)
```


```{r effective-debut-comparison, echo=F, fig.align="center", fig.cap="Percent Debuted In-Sim vs Data, Various Scenarios", out.width="70%"}
ages <- 15:44
# calibrated eligibility
eff_deb_calib <- dat[[6]]$effdebut*100

# from 10_1560 debut tracking sim
eff_deb_og <-  c(0.009363789, 0.058941781, 0.143552769, 0.240848193, 0.342852143, 0.434738607, 0.516314476, 0.594444046, 0.667909422, 0.728130341, 0.776367836, 0.820359054, 0.859432090, 0.883728213, 0.910764401, 0.927208922, 0.940291619, 0.947551619, 0.957545890, 0.962237502, 0.967736873, 0.969386924, 0.973694229, 0.973994443, 0.973894251, 0.975585668, 0.975469400, 0.978392997, 0.978194968, 0.980508975)*100

# cross-sectional debut status (empirical)
data_debut_cs <- c(0.1454219, 0.2878825, 0.4257733, 0.5830055, 0.7019795, 0.7984001, 0.8471828, 0.8459053, 0.8804078, 0.9146240, 0.9414704, 0.9453254, 0.9467009, 0.9639282, 0.9756667, 0.9820388, 0.9733068, 0.9727181, 0.9741881, 0.9809794, 0.9918823, 0.9832634, 0.9825848, 0.9836374, 0.9908677, 0.9896829, 0.9890290, 0.9871198, 0.9744849, 0.9877073)*100

# from youngboost
youngboost_deb <- dat[[7]]$effdebut*100

# scenario with NO debut terms - just effective debut tracking
nodebut <- c(0.0669383, 0.1859052, 0.2767750, 0.4112038, 0.5119332, 0.5817972, 0.6477404 ,0.7087435 ,0.7698317, 0.8181818 ,0.8479064, 0.8907168 ,0.9265672 ,0.9418398, 0.9580587, 0.9682825, 0.9748391 ,0.9816303, 0.9861111 ,0.9896468 ,0.9900990, 0.9859155,0.9951865 ,0.9981297 ,0.9951691 ,0.9969679, 0.9993846, 0.9994114 ,0.9994001, 0.9993675)*100

debut2 <- as.data.frame(cbind(ages, data_debut_cs, eff_deb_calib, eff_deb_og, youngboost_deb, nodebut))
colnames(debut2) <- c("Age", "Data (NSFG)", "Eligibility", "Default", "Default + Young Boost", "No Debut Term")
debut2 <- gather(debut2, key="Data", value = "Debut", -Age)

ggplot(debut2, aes(x=Age, y=Debut, col=Data)) +
  geom_point(aes(shape=Data), size=2.5) +
  theme(legend.position = c(.75, .45)) +
  scale_color_stata() +
  ylab("Percent Sexually Debuted")
```

This formation boost had an interesting effect on the networks. First off, we were able to finally match the distribution of relationships at younger ages. However, the increase in incidence at younger ages seemed to have increased the prevalence at older ages, so we still over-represent those relationships and overshoot our network-wide mean degree in both networks. The increase in relationships increased the average relationship duration in the marriage network, although it still falls short of the target by roughly one year. In terms of sexual debut (Figure \@ref(fig:effective-debut-comparison)), the rate of effective debut using the "eligibility" framework came closest to matching the empirical data, but the scenario that boost formation with the default debut framework failed to boost the effective debut enough (although it was an improvement over previous scenarios without any boosting of young-age formation). Interestingly, we ran an additional with all baseline parameters but without a simulation-governed debut process and found that the proportion of nodes who have ever formed a relationship by age in the model was term was almost identical to the model that contained a simulation-governed debut flagging process plus boosted formation at younger ages.


### Summary & Discussion

```{r summary-degs, echo=F, out.width="70%"}
degstab <- cbind(dat[[1]]$meandegs[,1:2], dat[[2]]$meandegs[,2], dat[[3]]$meandegs[,2],
                 dat[[4]]$meandegs[,2], dat[[5]]$meandegs[,2], dat[[6]]$meandegs[,2],
                 dat[[7]]$meandegs[,2])

colnames(degstab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure", "Increased Eligibility", "Young Age Boost")
kable(degstab, booktabs=T, caption = "Mean Degree Comparison Summary Table") %>%
  kable_styling(full_width=F) %>%
  column_spec(1:9, width = "1.6cm")

# latex_options = "scale_down" ?
```

```{r summary-durs, echo=F, out.width="70%"}
durstab <- cbind(dat[[1]]$meandurs[,1:2], dat[[2]]$meandurs[,2], dat[[3]]$meandurs[,2],
                 dat[[4]]$meandurs[,2], dat[[5]]$meandurs[,2], dat[[6]]$meandurs[,2],
                 dat[[7]]$meandurs[,2])

colnames(durstab) <- c("Target", "Base", "Older Partner Offset", "Increased Age Boundary", "Sim Window Correction", "Sim Window + Departure", "Increased Eligibility", "Young Age Boost")
kable(durstab, booktabs=T, caption = "Mean Relationship Duration Comparison Summary Table") %>%
  kable_styling(full_width=F) %>%
  column_spec(1:9, width = "1.6cm")
```

It is clear that there are no one-size-fits-all corrections that accommodate all population dynamics, and no single adjustment that we explored here is capable of addressing all of the problems introduced by attempting to match age-specific heterogeneity across a wide age range and between relationship types. There are however some key takeaways and recommendations regarding how to implement future adjustments. First takeaway is that while most adjustments influenced many of the key metrics at the same time, we need to focus on three primary issues: network-specific departure correction, boosting the formation at young ages, and making additional adjustments for the duration of very-long relationships. The second takeaway is that sexual debut may not be as large of a problem as originally expected, and it is work exploring what the effective debut profile of the population looks like when there is no specific debut term *and* boosted formation (see Chapter 3 for more on sexual debut and demographic corrections in networks with additional sex-specific complexities). Lastly, it is possible that some of the issues we have fitting these networks is related to the assumption that marriages and casual relationships both have a constant hazard of dissolution over time. Chapter 2 will explore this line of thought and attempt to describe the pattern of relationships lengths over the life-course and under what stratification the constant hazard may or may not be a reasonable assumption.  

In chapter three, we will remove the debut/readiness flagging process entirely and find that when we boost the formation at young ages to match the expected mean degree, we also match the proportion of nodes who have ever formed a relationship.
