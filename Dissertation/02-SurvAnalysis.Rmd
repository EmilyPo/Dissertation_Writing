# A Survival Analysis Perspective on Relationship Duration for ERGM-Based Epidemic Simulations {#surv}

```{r surv-libs, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(ggplot2)
library(gridExtra)
library(ggfortify)
#suppressWarnings(library(flexsurv))
library(survminer)
library(RColorBrewer)
library(kableExtra)
library(tidyverse)
library(philentropy)
library(srvyr)

dataset <- readRDS("~/nsfg_data_cleaning/Objects/altersegos_survdat.rds")

dataset$reltype2 = ifelse(dataset$reltype %in% "Other", 1, 2)
dataset$len <- dataset$t_c-dataset$t_o
dataset$reltype4[dataset$len<=1 & dataset$reltype2==1] <- 1
dataset$reltype4[dataset$len>1 & dataset$reltype2==1] <- 2
dataset$reltype4[dataset$reltype=="Cur/Fmr Cohab"] <- 3
dataset$reltype4[dataset$reltype=="Cur/Fmr Spouse"] <- 4

dat <- dataset %>% mutate(reltype = ifelse(reltype %in% "Cur/Fmr Cohab", "Cohab",
                                       ifelse(reltype %in% "Cur/Fmr Spouse", "Marriage",
                                        reltype)),
                      reltype2 = ifelse(reltype %in% "Cohab", "Cohab/Marriage",
                                       ifelse(reltype %in% "Marriage", "Cohab/Marriage",
                                        reltype)),
                      reltype4 = ifelse(reltype4==1, "Casual-short",
                                        ifelse(reltype4==2, "Casual-long",
                                               ifelse(reltype4==3, "Cohab",
                                                      ifelse(reltype4==4, "Marriage", NA)))))


# survival models
#--------- parametric / duration-only
expFit <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/nocovs/exp.rds")
weibFit <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/nocovs/weib.rds")
gammaFit <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/nocovs/gamma.rds")

 e.casual <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/nocovs/expcasual.rds")
e.marcoh <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/nocovs/expmarcoh.rds")

mixExpFit <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/mixed/mix-exp-nsfg.rds")
mixExpFitweighted <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/mixed/mix-exp-nsfg-weighted.rds")

#--------- parameteric / covariate --------------
e.reltype <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/ereltype.rds")
e.reltype3 <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/ereltype3.rds")
e.network <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/enetwork.rds")
e.agecat <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/age/expAgeCatCurrent.rds")
e.race <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/erace.rds")



e.agecat.Other <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/eagecatOther.rds")
e.agecat.Marcoh <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/eagecatMarcoh.rds")
e.race.Other <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/eraceOther.rds")
e.race.Marcoh <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/covs/eraceMarcoh.rds")

#-------kaplan-meier-------------
km_weighted <-  readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km-weighted.rds")
km_agecat_weighted <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_ac_weighted.rds")
km_reltype_weighted <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_reltype_weighted.rds")
km_reltype_weighted3 <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_reltype_weighted3.rds")
km_network_weighted <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_network_weighted.rds")
km_race <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_race_weighted.rds")
km_race_casual <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_race_casual.rds")
km_race_marcoh <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_race_marcoh.rds")
km_agecat_casual <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_agecat_casual.rds")
km_agecat_marcoh <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/km/km_agecat_marcoh.rds")

#-------young pop models----------
exp.young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/expFlex.rds")
e.reltype.young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/ereltype.rds")
e.network.young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/enetwork.rds")
km_young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/km-weighted.rds")
km_network_young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/km_network_weighted.rds")
km_reltype_young <- readRDS("~/Documents/Dissertation/R/Duration/Survival_Analysis/model_fits/1529/km_reltype_weighted.rds")
```

In the previous chapter, we stratified relationship types into two main categories: marriages/cohabitation, and casual relationships, with a single term for the probability of dissolution among each type. This is the standard in the recent literature, alongside a third network for one-off relationships that is important for the transmission of disease but that I set aside in the previous chapter in order to focus on models with relationship durations greater than one time step (I will continue to ignore these one-off relationships in the work below). Some recent models have also added terms to the dissolution models to stratify by race-dyad characteristics among each network type. However these networks, even with additional terms for race/ethnicity, assume an exponential process within each stratification. This reliance on a memoryless process makes the estimation of the underlying temporal ERGM (TERGM) more tractable, but may have some unintended consequences. While we can reproduce the mean relationship length estimated from empirical data in the network simulations, it is currently unknown how well the exponential framework reproduces the full distribution of empirical relationship lengths. In this chapter I will first begin with an explanation of the importance of relationship length on the transmission of STIs, highlight some key issues related to demographic trends and constraints of current epidemic models, and set up the scope of the analysis. Then I will use parametric and non-parametric tools from survival analysis to compare models of relationship duration and some simple extensions to the exponential framework, with the goal of exploring how well this memoryless processes captures the empirical distributions of relationship length in the National Survey of Family Growth overall and among various stratifications.

## Relationship Length Overview  

The duration of sexual relationships across a population is a key component of the network structure responsible for either exposing individuals to or protecting individuals from sexually transmitted infections (STIs). Relationship duration determines the length of exposure to pathogens, or in the case of a disease-free monogamous partnership, protection from pathogens. In addition to dictating this period of possible exposure, relationship durations relative to the pathogen-specific duration of infection are an important driver of how quickly STIs can spread throughout a population. Transmission beyond a pair of actors for infections with short durations relative to relationship lengths is challenging and slow, and it is more likely that an infection will be detected and treated or resolved naturally prior to the dissolution of the relationship. If the duration of infection and duration of relationships are more equal, there is a greater chance that the infection can spread to future partners and throughout the network. When partnerships overlap, transmission pathways increase even among those individuals with few lifetime partners, and this effect is even greater when the duration of overlap is large ([@Armbruster2017, @Morris1997]).  

The pattern of relationship durations across the life-course is also important because STIs often have distinct age patterns in terms of prevalence. Individual age is often used as a predictor for risky sexual behavior, but there is additional complexity when considering the effect of age on the duration of relationships across the life-course. Young age likely influences the immediate intentions for relationships (i.e. serious or casual), and the frequency at which individuals form new relationships, but somewhat paradoxically it is also true that the only people who can report extremely long relationships are those who started them at young ages. This also introduces complex sampling issues because most data on relationship durations is collected cross-sectionally or retrospectively â€“ not longitudinally (see description of methods below for more on this). Given the importance of relationship duration to features of STI epidemiology discussed above, there is growing interest in improving the representation of relational durations in dynamic network models used to study epidemics.  

As we used in the first chapter and will continue to use throughout this dissertation, one common class of models used to understand network influences on patterns of STI transmission is known as separable temporal exponential-family random graph models (STERGMs). These models are governed by two expressions: one that represents the set of processes that influence the formation of relationships, and a comparable one for dissolution [@Krivitsky2014]. We have previous explored some corrections to these expressions related to unexpected effects of certain demographic processes, but here we explore assumptions inherent in the dissolution component in more detail. The current standard practice for the dissolution models in this modeling framework assumes that once a relationship begins, its persistence is governed by a constant hazard. As previously alluded to, this memoryless process is a convenient simplifying assumption that makes TERGM estimation easier, but it seems unlikely that this assumption faithfully represents the distribution all relationship durations we observe across a wide range of ages.  

Epidemic models in the recent literature have addressed this simplification by splitting out relationships into two categories: the first, marriages and cohabitations or main partnerships, and the second, persistent or casual partnerships. These are then modeled as separate networks simultaneously. This strategy is what we employed in the first chapter. By structuring the model in this fashion, each network has a hazard of dissolution specific to its type. (These models often have a third network for one-time sexual contacts which last only one time-step, but this network is not the focus of our study). While these models are indeed able to reproduce the mean relationship lengths drawn from empirical data, it remains unknown how well these strategies reproduce the full distribution of lengths observed. In particular, the memoryless assumption means that the modal length of main partnerships remains near zero across all ages, which basic intuition says is not true and descriptive data analysis confirms. Other work has considered disaggregating relational durations by a single demographic attribute of their members related to a hypothesis or prevention modality being explored, but again with no further effort to capture the full distribution, particularly by age [@Goodreau2017, @Jenness2017].  

## Data
The combined 2006-2015 waves of the National Survey of Family Growth once again provide the empirical data for this investigation. In these analyses, however, instead of using only the relationship active at the time of interview (the cross-sectional distribution), we now use all of the data on current and past relationships (except for one-time partners). As mentioned briefly in the introduction, the survey design makes the information on relationship duration somewhat more complex to analyze than the other questions of interest. Each participant, if they have indicated they have had sexual intercourse, is asked about their three most recent relationships that are either ongoing or have ended within the last year. We then define relationship duration as the difference between the month the ego reported first having sex with this partner and either the last month they reported sexual intercourse with that partner or the day of the interview if the relationship is ongoing. All relationships active on the day of the interview have right-censored duration since we do not know if or when they will end. Additionally, because we calculate duration from retrospective information, we also introduce left truncation that biases mean duration estimates upwards. For example, if someone reports having one monogamous 15-year relationship, we essentially know their 15-year relationship history. However, if someone has serial short relationships or long time intervals between relationships, we do not see these relationships going back 15 years, so we actually gather different amounts of information from each participant. Figure \@ref(fig:censoring) highlights these phenomena. Blue relationships are those lengths that we observe via the NSFG questionnaire. Red extensions to the blue lines represent the theoretical true duration among the right-censored relationships. Green lines are those hypothetical relationships that could have occurred in the intervals that we do not observe for each participant. Many methods in survival analysis have corrections for these types of censoring and are employed in the relevant analyses.

```{r censoring, echo=F, fig.align="center", fig.cap="Known and Censored Relationships in NSFG"}
dat2 <- readRDS("~/nsfg_data_cleaning/Objects/altersegos_survdat.rds")
# observed rels
examples <- dat2[1:50,]
examples <- examples %>% select(dfs, dls, active) %>% mutate(dfs=-dfs, dls=-dls) %>% mutate(dfs_c = dls)
examples$id <- c(1:nrow(examples))

# left truncated rels
second <- dat2[51:100,] %>% select(dfs, dls, active) %>% mutate(dfs=-dfs, dls=-dls)
offset <- sample(5:30, 50, replace=T)
second <- cbind(second,offset)
second <- second %>% mutate(dfs=dfs-offset, dls=dls-offset)
second <- second[1:37,]
second$id <- seq(1,74, by=2)

# right censored rels
rights <- examples %>% filter(dls==0 & active==1)
rights$dls_c <- sample(1:20, nrow(rights), replace=T)

#### plot ####
plot(x=NA,
  xlim=c(-350, 60), xaxt='na', xlab=NA,
  ylim=c(0, 51), yaxt='n', ylab=NA,
  main = ""
)
# obs window
abline(v=-12, lty=2)
abline(v=0, lty=2)
# observed rels
segments(
  x0=examples$dls,
  x1=examples$dfs,
  y0=order(examples$id),
  col="darkblue"
)
# truncated (unobserved) rels
segments(
  x0=second$dls,
  x1=second$dfs,
  y0=second$id,
  col="darkgreen"
)
# right-censored examples
segments(
  x0=rights$dfs_c,
  x1=rights$dls_c,
  y0=rights$id,
  col="darkred"
)
# legend
legend("bottomleft", legend = c("Observation Window", "Known Durations", "Possible Right Censored Durations", "Possible Unobserved (Truncated) Durations"),
       col = c("black", "darkblue", "darkred", "darkgreen"), lty=c(2,1,1,1), lwd=2, cex=0.65)
rm(dat2)
```



## Methods
First, the relational duration data is displayed using histograms (overall, by relationship type, and by age category). These histograms are not corrected for any censoring, therefore are solely used to get a visual sense of the underlying patterns. In the main analysis we explore several parametric survival models to gain insights into the underlying heterogeneity in hazard of dissolution. The goal here is not to find the most perfect fitting model, but to explore some simple extensions of the exponential that may be implemented within the constraints of current epidemic network models to better capture the full distribution of relationship lengths. Unless otherwise specified, the parametric models are fit using the R package 'flexsurv' adjusting for the right-censoring and left-truncation [@Jackson2006]. All models use the survey weights provided by the NSFG, which weight the observations to the age, sex, and race composition of the United States. Model fit is evaluated by the Akaike Information Criterion (AIC) and visually by using a Modified Kaplan-Meier (following @Burington2010 and fit using the R package â€˜survivalâ€™) as reference curves to compare the survival of the empirical relationships to that of the fitted models. (BIC is not presented because the number of model parameters is so small between fits that the BIC and AIC provide almost identical outputs and any conclusions about model fit are unaltered). Additional visual comparison will be done using a PP-Plot, which plots two survival distributions against one another in order to visually evaluate the divergence between them (@Cox2014). Models with ego attribute covariates  will be fit twice: once using the all relationships and once stratified by two-category relationship type (marriages and cohabitations, casual) to reflect the current standard practice in the literature and to explore under what conditions the exponential process with stratifications may be a reasonable approximation of the data.  

## Descriptive Histograms  
```{r histscode, echo=FALSE, cache=T}
xmax <- 30
ymax <- 7e6

allRels <- dat %>%
            ggplot(aes(x = t_c_years, weights = e.weight)) +
            geom_histogram(binwidth = 0.25) +
            scale_x_continuous(name="Relationship Age, Years") +
            scale_y_continuous(name="Weighted Count in Millions") +
            theme(aspect.ratio=1)

#"#76c0c1"
allRelsType <- dat %>%
            ggplot(aes(x = t_c_years, fill = reltype2, weights = e.weight)) +
            geom_histogram(binwidth = 0.25) +
            scale_x_continuous(name="Relationship Age, Years") +
            scale_y_continuous(name="Weighted Count in Millions") +
            theme(aspect.ratio=1) +
            labs(fill="Rel Type") +
            scale_fill_manual(name="Rel Type", values=c("#014d64", "#6974a7")) +
            facet_wrap("reltype2")
```
At first glance, the histogram of all relationships looks like something we would expect from an exponential distribution: a high decay right at the beginning, and a long right tail. However, it is clear from Figure \@ref(fig:hist-reltype) that this shape is primarily driven by the casual relationships rather than the marriages and cohabitations. The marriages and cohabitations are not uniformly distributed, but have a slower, linear-looking decay after an initial peak around three months. These trends are largely maintained if we break these types down further by age category of the reporting ego. Among casual relationships the primary age differences are 1) the number of relationships, 2) the frequency of short casual relationships versus longer casual relationships, with more frequent short relationships in younger age categories and a wide range of longer casual relationships maintained at older ego ages. Interestingly, the marriage and cohabitations look increasingly uniform with age. This may indicate that for certain relationship types, and for certain age groups, a simple constant hazard of dissolution may not accurately capture the distribution overall or over the life-course. Appendix Figure \@ref(fig:more-hists) further breaks down these histograms by censoring status (i.e. ended or ongoing). The overall shape of the distribution is similar between relationships that are ongoing versus those that are ended, although there are far more short casual relationships that have ended than are ongoing and far fewer ended marriages and cohabitations than are ongoing.  

```{r hist-all, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="All Relationships either Current or Ended in the Last Year", out.width="50%", cache=T}
allRels
```
```{r hist-reltype, echo=FALSE, warning=FALSE, fig.align="center", fig.cap="All Relationships either Current or Ended in the Last Year, By Type", out.width="80%", cache=T}
allRelsType + theme(legend.position = "none")
```
```{r hist-agecat-casual, echo=FALSE, fig.cap="Casual Relationships, by Age Category", fig.align="center", cache=T, out.width="70%"}
allRelsAgecatType <- dat %>% filter(reltype2 == "Other") %>%
            ggplot(aes(x = t_c_years, fill = reltype2, weights = e.weight)) +
            geom_histogram(binwidth = 0.25) +
            scale_x_continuous(name="Relationship Age, Years") +
            scale_y_continuous(name="Weighted Count in Millions", limits=c(0,750)) +
            theme(aspect.ratio=1) +
            labs(fill="Rel Type") +
            scale_fill_manual(name="Rel Type", values=c("#014d64", "#6974a7")) +
            facet_wrap(c("e.agecat"), ncol=3) +
            theme(aspect.ratio=1, legend.position = "none")

suppressWarnings(print(allRelsAgecatType))
```
```{r hist-agecat-marcoh, echo=FALSE, fig.cap="Mariages and Cohabitations, by Age Category", fig.align="center", cache=T, out.width="70%"}
allRelsAgecatTypeMar <- dat %>% filter(reltype2 == "Cohab/Marriage") %>%
            ggplot(aes(x = t_c_years, fill = reltype2, weights = e.weight)) +
            geom_histogram(binwidth = 0.25) +
            scale_x_continuous(name="Relationship Age, Years") +
            scale_y_continuous(name="Weighted Count in Millions", limits=c(0,750)) +
            theme(aspect.ratio=1) +
            labs(fill="Rel Type") +
            scale_fill_manual(name="Rel Type", values=c("#014d64", "#6974a7")) +
            facet_wrap(c("e.agecat"), ncol=3) +
            theme(aspect.ratio=1, legend.position = "none")

suppressWarnings(print(allRelsAgecatTypeMar))
```

## Duration-Only Models  
As a first pass, we fit several duration-only (covariate free) models using 3 different but related distributions: the exponential, the Weibull, and the gamma. It would not be ideal to use either the Weibull or gamma as a dissolution model in our STERGMs because the parameterization would be dependent on the current duration of each relationship. This is not impossible, but it is computationally intensive and might reduce the speed at which the simulation could run. However, we choose to look at them because they are related to the exponential and a better fit using these distributions would represent that there is a heterogeneity in the data that the single-parameter exponential doesn't capture. Figures \@ref(fig:exp-dist-surv) and \@ref(fig:ppplot1) display these results. In \@ref(fig:exp-dist-surv), the data are represented by the black Kaplan-Meier curve and the fitted models with various distributions are in color. In Figure \@ref(fig:ppplot1), the parametric models are plotted against the Kaplan-Meier survival estimates at each time step. Lines that fall above the (0,1) reference line represent places in the curve where the parametric model overestimates the survival of relationships and lines below the curve are where the parametric models underestimate the survival relative to the data. As we expected based on the histograms, a single exponential does not capture the full distribution of relationships well, but while the weibull and gamma capture the survival of shorter relationships better, all of the distributions fail to capture the very long, almost flat right tail of the data. While none of the covariate-free models capture the overall distribution of relationships, it is clear that there is important heterogeneity in the data that the exponential cannot capture alone. It is worth noting at this point that the parametric models assume that even though much of the data is right-censored, eventually all relationships dissolve and the survival curve will go to zero. This would be true if our data was gathered among egos across the full distribution of the human lifespan. But this is not the case, and because the Kaplan-Meier curves do not have this assumption, we will likely have poor fit in the tails of the the long relationship distributions across all models.  

```{r exp-dist-surv, echo=FALSE, fig.align="center", fig.cap="Various Duration-Only Survival Models, All Relationships", out.width="60%"}
logit = function(p){
  log(p/(1-p))
}

invLogit = function(phi){
  1/(1+exp(-phi))
}

durVec <- c(1:max(km_weighted$time))

blue <- "#475F77"
green <- "#666633"
orange <- "#C46B29"
yellow <- "#F4D27A"
pink <- "#CC6666"
grey <- "#747E80"


plot(km_weighted,
     conf.int = FALSE,
     xlab = "t, months", ylab = "S(t)",
     lwd=2, lty=2
)
lines(expFit, col=blue, lwd=2)
lines(weibFit, col=orange, lwd=2)
lines(gammaFit, col=pink, lwd=2)
legend("topright", legend = c("Kaplan-Meier", "Exponential", "Weibull", "Gamma"),
col = c("black", blue, orange, pink), cex=0.75, lwd=2, lty = c(2,1,1,1))
```

```{r ppplot1, cache=T, echo=FALSE, fig.align="center", fig.cap="P-P Plot Comparison, K-M vs Various Probability Distributions", fig.asp=1, out.width="50%"}
plot(x=km_weighted$surv, y=as.data.frame(summary(expFit))$est, ylim=c(0,1), xlim=c(0,1), col=blue, type = "l", lwd=2,
     xlab="Fitted Models", ylab="Kaplan-Meier")
lines(x=km_weighted$surv, y=as.data.frame(summary(weibFit))$est, col=orange , lwd=2)
lines(x=km_weighted$surv, y=as.data.frame(summary(gammaFit))$est, col=pink, lwd=2)
abline(0,1)
legend("topleft", legend = c("Exponential", "Weibull", "Gamma"),
col = c(blue, orange, pink), cex=0.75, lwd=2, lty = c(1))
```


## Simple Extensions to the Exponential
### Relationship Type: Current Standard

Figure \@ref(fig:exp-networktype) stratifies the relationships into their Marriage/Cohabitation or Casual designations. Each relationship type then has its own hazard of dissolution, but within each relationship type the hazard is constant. The curve for the casual partnerships fits remarkably well to the reference Kaplan-Meier at first glance, but the p-p-plot highlights the difference in dissolution rate at the start of casual relationships. The Kaplan-Meier tells us that almost 20% of casual relationships fail within the first month but the exponential estimate is rather more conservative. Conversely, the exponential somewhat underestimates the survival of the longest casual relationships - likely a reflection of what we saw in the histograms of casual relationships at older ages that had much greater variation in length. The curve for marriage/cohabitations demonstrates similar issues. This model over-represents the survival of relationships that last less than four years, but under-estimates the survival of longer relationships. Clearly there is more heterogeneity here that we will try to tease out in the next examples.  

```{r exp-network, echo=F, fig.align='center', fig.cap="Kaplan-Meier vs Exponential - All Relationships", out.width="60%", include=FALSE}
n1 <- as.data.frame(summary(expFit))
plot(km_weighted, lty=2, lwd=2,
       col = brewer.pal(9, "Blues")[c(8)],
       ylab="S(t)", xlab = "t, Months",
       xlim=c(0,348))
lines(n1$est, type = "l", col = brewer.pal(9, "Blues")[8], lwd=2)
legend("topright", lty=c(rep(1,2), rep(2,2)), lwd=c(rep(2,4)),
         col=c(rep(brewer.pal(9, "Blues")[8],2)),
         legend = c("All Relationships",
                     "K-M Reference: All"), bty="n", cex=0.8)
```
```{r exp-networktype, echo=F, fig.cap="Kaplan-Meier vs Exponential - By Relationship Type", out.width="60%", fig.align='center'}
n <- summary(e.network)
plot(km_network_weighted, lty=2, lwd=2,
       conf.int = FALSE,
       col = c(orange, blue),
       ylab="S(t)", xlab = "t, Months",
       xlim=c(0,348))
lines(n$`network1=marcoh`$est, type = "l", col = orange, lwd=2)
lines(n$`network1=other`$est, type = "l", col = blue, lwd=2)
legend("topright", lty=c(rep(1,2), rep(2,2)), lwd=c(rep(2,4)), col=c(rep(c(orange, blue),2)),
         legend = c("Marriage/Cohab", "Other",
                     "K-M: M/C", "K-M: O"), bty="n", cex=0.8, ncol=2)
```
```{r pplot-networks, echo=F, fig.cap="PP Plot, Kaplan-Meier vs Exponential - By Relationship Type", out.width="50%", fig.asp=1, fig.align='center'}
len <- length(km_network_weighted$surv)

t <- n$`network1=marcoh`$time
est <- n$`network1=marcoh`$est
times <- km_network_weighted$time[1:342]
survs <- km_network_weighted$surv[1:342]
jointtimes <- intersect(t, times)
indexp <- which(t %in% jointtimes)
indexkm <- which(times %in% jointtimes)

times2 <- km_network_weighted$time[343:length(km_network_weighted$time)]
survs2 <- km_network_weighted$surv[343:length(km_network_weighted$time)]
jointtimes2 <- intersect(t, times2)
indexp2 <- which(t %in% jointtimes2)
indexkm2 <- which(times2 %in% jointtimes2)

plot(x=survs[indexkm], y=est[indexp], type = "l", col = orange, lwd=2, ylim=c(0,1), xlim=c(0,1),
    xlab="Kaplan-Meier", ylab="Fitted Exponential by Network Type")
abline(0,1)
lines(x=survs2[indexkm2], y=n$`network1=other`$est[indexp2], type = "l", col = blue, lwd=2)
legend("topleft", lty=c(rep(1,2), rep(2,2)), lwd=2, col=c(orange, blue),
         legend = c("Marriage/Cohab", "Other"), bty="n", cex=0.8)
```

### Age Category  
Here we break down the relationships by age category of reporting ego (Figure \@ref(fig:agecat)), and then further by relationship type and age category (Figure \@ref(fig:agecat-networks). The Kaplan-Meier reference curve by age category alone shows very little difference in the survivorship of relationship among egos aged 25 and above, although the maximum length observed increases with age category (as expected). These difference in the maximum length however likely explain why the exponential curves predict large differences in survivorship by age category and overestimate the survival relative to the reference curves. Interestingly, relationships seem to dissolve at very similar rates in the first few months regardless of age category - a property that this model certainly does not reflect. The youngest ages come somewhat closer to their reference curves, but as the p-p-plot demonstrates, all strata suffer from overestimating the survival of young relationships and underestimating the long relationships.
The model of age category among casual relationships (Figure \@ref(fig:agecat-networks), left) reveals very small differences in the curve between age categories, but all curves follow the now well-established deviation patterns relative to their Kaplan-Meier references. It seems we gain very little by adding age category as a covariate among casual relationships. While the *frequency* of casual relationships decreases across the life course, it seems that the *length* of these relationships follows a relatively similar pattern. Conversely, age category among marriages and cohabitations does seem to add to our overall fit (Figure \@ref(fig:agecat-networks), right). In particular, the curves within three youngest age groups (15-19, 20-24, and 25-30) fits their K-M references remarkably well. These observations are confirmed in the p-p-plots, Figure \@ref(fig:pplot-agecat-networks). We might expect this lack of fit at older ages in the marriage/cohabitation network pattern based on the increasingly uniform distribution in the histograms among older ages. This is perhaps not surprising, in that the length of relationship lengths is at least partly an emergent property rather than a causal one. That is, no individual can have a relationship that has lasted longer than they have been sexually active, so the range of relationship lengths for young age categories is relatively small and easier to represent. Meanwhile, the older age categories are challenging to represent because the possible range of relationships is so much larger, and are likely influenced not only by dissolution probabilities but also by the changing formation probabilities over the life-course â€“ that is, older people in long-term relationships do not start new relationships at the same rate as others, and thus have relatively few relationships that are short.

```{r agecat, fig.align="center", fig.cap="Exponential and K-M by Current Age Category", echo=FALSE, out.width="60%"}
s <- summary(e.agecat)
plot(km_agecat_weighted, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow, green, grey),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,348))
lines(s$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2)
lines(s$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(s$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(s$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(s$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(s$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
legend("topright", lty=c(rep(1,6), rep(2,6)), lwd=c(rep(2,12)),
       col=c(rep(c(blue, orange, pink, yellow, green, grey),2)),
       legend = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44",
                   "K-M: 15-19", "K-M: 20-24", "K-M: 25-29",
                   "K-M: 30-34", "K-M: 35-39", "K-M: 40-44"), bty="n", cex=0.8, ncol=2)
```
```{r pplot-agecat, eval=F, echo=F, fig.cap="PP Plot, Exponential vs K-M, By Age Category", out.width="50%", fig.asp=1, fig.align='center'}
n <- length(s$`e.agecat=15-19`$est)
times <- km_agecat_weighted$time[1:86]+1
survs <- km_agecat_weighted$surv[1:86]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s$`e.agecat=20-24`$est)
times <- km_agecat_weighted$time[87:230]+1
survs <- km_agecat_weighted$surv[87:230]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s$`e.agecat=25-29`$est)
times <- km_agecat_weighted$time[231:424]+1
survs <- km_agecat_weighted$surv[231:424]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s$`e.agecat=30-34`$est)
times <- km_agecat_weighted$time[425:668]+1
survs <- km_agecat_weighted$surv[425:668]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s$`e.agecat=35-39`$est)
times <- km_agecat_weighted$time[669:968]+1
survs <- km_agecat_weighted$surv[669:968]
times[1] <- 1
fit5 <- rep(NA, n)
fit5[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s$`e.agecat=40-44`$est)
times <- km_agecat_weighted$time[969:length(km_agecat_weighted$time)]+1
survs <- km_agecat_weighted$surv[969:length(km_agecat_weighted$time)]
times[1] <- 1
fit6 <- rep(NA, n)
fit6[times[which(times<=n)]] <- survs[which(times<=n)]

plot(x=fit1, y=s$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1),
      xlab="Kaplan-Meier", ylab="Fitted Exponential by Age Category")
lines(x=fit2, y=s$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=s$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=s$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(x=fit5, y=s$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(x=fit6, y=s$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
abline(0,1)
legend("topleft", lwd=2, col=c(blue, orange, pink, yellow, green, grey),
       legend = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44"), bty="n", cex=0.8, ncol=2)
```
```{r agecat-networks, fig.align="center", fig.cap="Exponential and K-M, By Age Category and Relationship Type", echo=FALSE, out.width="60%"}
s1 <- summary(e.agecat.Other)
s2 <- summary(e.agecat.Marcoh)

par(mfrow=c(1,2))
plot(km_agecat_casual, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow, green, grey),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,100))
lines(s1$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2)
lines(s1$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(s1$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(s1$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(s1$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(s1$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
legend("topright", lty=c(rep(1,6), rep(2,6)), lwd=c(rep(2,12)),
       col=c(rep(c(blue, orange, pink, yellow, green, grey),2)),
       legend = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44",
                   "K-M: 15-19", "K-M: 20-24", "K-M: 25-29",
                   "K-M: 30-34", "K-M: 35-39", "K-M: 40-44"), bty="n", cex=0.5, ncol=2)


plot(km_agecat_marcoh, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow, green, grey),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,348))
lines(s2$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2)
lines(s2$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(s2$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(s2$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(s2$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(s2$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
```
```{r pplot-agecat-networks, echo=F, fig.cap="PP Plot, Exponential vs K-M, By Age Category and Relationship Type", out.width="60%", fig.align='center'}
n <- length(s1$`e.agecat=15-19`$est)
times <- km_agecat_casual$time[1:81]+1
survs <- km_agecat_casual$surv[1:81]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s1$`e.agecat=20-24`$est)
times <- km_agecat_casual$time[82:208]+1
survs <- km_agecat_casual$surv[82:208]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s1$`e.agecat=25-29`$est)
times <- km_agecat_casual$time[209:370]+1
survs <- km_agecat_casual$surv[209:370]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s1$`e.agecat=30-34`$est)
times <- km_agecat_casual$time[371:572]+1
survs <- km_agecat_casual$surv[371:572]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s1$`e.agecat=35-39`$est)
times <- km_agecat_casual$time[573:783]+1
survs <- km_agecat_casual$surv[573:783]
times[1] <- 1
fit5 <- rep(NA, n)
fit5[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s1$`e.agecat=40-44`$est)
times <- km_agecat_casual$time[784:length(km_agecat_casual$time)]+1
survs <- km_agecat_casual$surv[784:length(km_agecat_casual$time)]
times[1] <- 1
fit6 <- rep(NA, n)
fit6[times[which(times<=n)]] <- survs[which(times<=n)]

par(mfrow=c(1,2))
plot(x=fit1, y=s1$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1), ann=FALSE)
lines(x=fit2, y=s1$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=s1$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=s1$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(x=fit5, y=s1$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(x=fit6, y=s1$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
abline(0,1)
legend("bottomright", lwd=2, col=c(blue, orange, pink, yellow, green, grey),
       legend = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44"), bty="n", cex=0.5, ncol=2)

n <- length(s2$`e.agecat=15-19`$est)
times <- km_agecat_marcoh$time[1:66]+1
survs <- km_agecat_marcoh$surv[1:66]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s2$`e.agecat=20-24`$est)
times <- km_agecat_marcoh$time[67:201]+1
survs <- km_agecat_marcoh$surv[67:201]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s2$`e.agecat=25-29`$est)
times <- km_agecat_marcoh$time[202:391]+1
survs <- km_agecat_marcoh$surv[202:391]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s2$`e.agecat=30-34`$est)
times <- km_agecat_marcoh$time[392:633]+1
survs <- km_agecat_marcoh$surv[392:633]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s2$`e.agecat=35-39`$est)
times <- km_agecat_marcoh$time[634:927]+1
survs <- km_agecat_marcoh$surv[634:927]
times[1] <- 1
fit5 <- rep(NA, n)
fit5[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(s2$`e.agecat=40-44`$est)
times <- km_agecat_marcoh$time[928:length(km_agecat_marcoh$time)]+1
survs <- km_agecat_marcoh$surv[928:length(km_agecat_marcoh$time)]
times[1] <- 1
fit6 <- rep(NA, n)
fit6[times[which(times<=n)]] <- survs[which(times<=n)]

plot(x=fit1, y=s2$`e.agecat=15-19`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1), ann=FALSE)
lines(x=fit2, y=s2$`e.agecat=20-24`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=s2$`e.agecat=25-29`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=s2$`e.agecat=30-34`$est, type = "l", col = yellow, lwd=2)
lines(x=fit5, y=s2$`e.agecat=35-39`$est, type = "l", col = green, lwd=2)
lines(x=fit6, y=s2$`e.agecat=40-44`$est, type = "l", col = grey, lwd=2)
abline(0,1)
legend("bottomright", lwd=2, col=c(blue, orange, pink, yellow, green, grey),
       legend = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44"), bty="n", cex=0.5, ncol=2)
```

### Race/Ethnicity
Here we add a covariate for race/ethnicity of respondents. The results here are somewhat analogous to the age category covariate results. In the pooled relationship model (Figure (\@ref(fig:race)), the Kaplan-Meier curves are almost identical between race/ethnicity groups until roughly 40% of relationships remain, around 20 weeks. The differences lie in the survival of the longest relationships. The exponential fits here are worse than using age category as a covariate. Among casual relationships (Figure \@ref(fig:race-network), left)), we similarly gain little in adding race/ethnicity as a covariate. As above, the story for marriages and cohabitations is different. Here, the Kaplan-Meier shows clear differences in surviorship of relationships among Non-Hispanic Black respondents relative to all others. While this observation is reflected in the race covariate model as well, this stratified exponential models still fail to capture these relationships (particularly at the longest relationships). Figure \@ref(fig:pplot-race-network) shows that the deviance between the Kaplan-Meier and the exponential curves are very similar across race/ethnicity groups, highlighting the poor fit.

```{r race, fig.align="center", fig.cap="Kaplan-Meier vs. Constant Hazard by Race/Ethnicity", echo=FALSE, out.width="70%"}
r <- summary(e.race)
plot(km_race, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,348))
lines(r$`e.race=b`$est, type = "l", col = blue, lwd=2)
lines(r$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(r$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(r$`e.race=w`$est, type = "l", col = yellow, lwd=2)
legend("topright", lty=c(rep(1,4), rep(2,4)), lwd=c(rep(2,8)),
       col=c(rep(c(blue, orange, pink, yellow),2)),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White",
                   "K-M: NH-Black", "K-M: Hispanic",
                   "K-M: Other", "K-M: NH-White"), bty="n", cex=0.8, ncol=2)
```
```{r pplot-race, echo=F, fig.cap="PP Plot, Kaplan-Meier vs Exponential - By Race/Ethnicity", out.width="60%", fig.asp=1, fig.align='center', eval=F}
n <- length(r$`e.race=b`$est)
times <- km_race$time[1:311]+1
survs <- km_race$surv[1:311]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r$`e.race=h`$est)
times <- km_race$time[312:626]+1
survs <- km_race$surv[312:626]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r$`e.race=o`$est)
times <- km_race$time[627:873]+1
survs <- km_race$surv[627:873]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r$`e.race=w`$est)
times <- km_race$time[874:length(km_race$time)]+1
survs <- km_race$surv[874:length(km_race$time)]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

plot(x=fit1, y=r$`e.race=b`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1),
      xlab="Kaplan-Meier", ylab="Fitted Exponential by Race")
lines(x=fit2, y=r$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=r$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=r$`e.race=w`$est, type = "l", col = yellow, lwd=2)
abline(0,1)
legend("topleft", lwd=2, col=c(blue, orange, pink, yellow),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White"), bty="n", cex=0.8, ncol=2)
```
```{r race-network, fig.align="center", fig.cap="Kaplan-Meier vs. Exponential by Race/Ethnicity and Relationship", echo=FALSE, out.width="80%"}
r1 <- summary(e.race.Other)
r2 <- summary(e.race.Marcoh)
par(mfrow=c(1,2))
plot(km_race_casual, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,100))
lines(r1$`e.race=b`$est, type = "l", col = blue, lwd=2)
lines(r1$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(r1$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(r1$`e.race=w`$est, type = "l", col = yellow, lwd=2)
legend("topright", lty=c(rep(1,4), rep(2,4)), lwd=c(rep(2,8)),
       col=c(rep(c(blue, orange, pink, yellow),2)),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White",
                   "K-M: NH-Black", "K-M: Hispanic",
                   "K-M: Other", "K-M: NH-White"), bty="n", cex=0.5, ncol=2)
plot(km_race_marcoh, lty=2, lwd=2,
     col = c(blue, orange, pink, yellow),
            conf.int = FALSE,
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,348))
lines(r2$`e.race=b`$est, type = "l", col = blue, lwd=2)
lines(r2$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(r2$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(r2$`e.race=w`$est, type = "l", col = yellow, lwd=2)
legend("topright", lty=c(rep(1,4), rep(2,4)), lwd=c(rep(2,8)),
       col=c(rep(c(blue, orange, pink, yellow),2)),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White",
                   "K-M: NH-Black", "K-M: Hispanic",
                   "K-M: Other", "K-M: NH-White"), bty="n", cex=0.5, ncol=2)
```
```{r pplot-race-network, echo=F, fig.cap="PP Plot, Kaplan-Meier vs Exponential - By Race/Ethnicity and Relationship", out.width="60%", fig.align='center'}
n <- length(r1$`e.race=b`$est)
times <- km_race_casual$time[1:235]+1
survs <- km_race_casual$surv[1:235]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r1$`e.race=h`$est)
times <- km_race_casual$time[236:402]+1
survs <- km_race_casual$surv[236:402]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r1$`e.race=o`$est)
times <- km_race_casual$time[403:504]+1
survs <- km_race_casual$surv[403:504]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r1$`e.race=w`$est)
times <- km_race_casual$time[505:length(km_race_casual$time)]+1
survs <- km_race_casual$surv[505:length(km_race_casual$time)]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

par(mfrow=c(1,2))
plot(x=fit1, y=r1$`e.race=b`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1), ann=FALSE)
lines(x=fit2, y=r1$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=r1$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=r1$`e.race=w`$est, type = "l", col = yellow, lwd=2)
abline(0,1)
legend("bottomright", lwd=2, col=c(blue, orange, pink, yellow),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White"), bty="n", cex=0.5, ncol=2)


n <- length(r2$`e.race=b`$est)
times <- km_race_marcoh$time[1:298]+1
survs <- km_race_marcoh$surv[1:298]
times[1] <- 1
fit1 <- rep(NA, n)
fit1[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r2$`e.race=h`$est)
times <- km_race_marcoh$time[299:612]+1
survs <- km_race_marcoh$surv[299:612]
times[1] <- 1
fit2 <- rep(NA, n)
fit2[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r2$`e.race=o`$est)
times <- km_race_marcoh$time[613:857]+1
survs <- km_race_marcoh$surv[613:857]
times[1] <- 1
fit3 <- rep(NA, n)
fit3[times[which(times<=n)]] <- survs[which(times<=n)]

n <- length(r2$`e.race=w`$est)
times <- km_race_marcoh$time[858:length(km_race_marcoh$time)]+1
survs <- km_race_marcoh$surv[858:length(km_race_marcoh$time)]
times[1] <- 1
fit4 <- rep(NA, n)
fit4[times[which(times<=n)]] <- survs[which(times<=n)]

plot(x=fit1, y=r2$`e.race=b`$est, type = "l", col = blue, lwd=2, xlim=c(0,1), ylim=c(0,1), ann=FALSE)
lines(x=fit2, y=r2$`e.race=h`$est, type = "l", col = orange, lwd=2)
lines(x=fit3, y=r2$`e.race=o`$est, type = "l", col = pink, lwd=2)
lines(x=fit4, y=r2$`e.race=w`$est, type = "l", col = yellow, lwd=2)
abline(0,1)
legend("bottomright", lwd=2, col=c(blue, orange, pink, yellow),
       legend = c("NH-Black", "Hispanic", "Other", "NH-White"), bty="n", cex=0.5, ncol=2)
```

## Additional Relationship Types  
Here we try to address the two phenomena that have been through-lines in the above results: first, that neither age category nor race adds meaningful value to the casual models and consistently underestimates the rate of dissolution in the first few weeks of beginning a relationships and second, that these covariates when applied to the marriage/cohabitation only seem to help fit the relationships that are somewhat shorter: relationships among younger and/or Non-Hispanic Black respondents. It is my hypothesis that these latter observations are due to a false assumption that cohabitations and marriages have similar properties and dissolution rates. Recent work in the field of family demography that has shown that there are significant differences in the risk of dissolution between cohabitations and marriages and that these differences are due to variation in joint lifestyles (van Houdt and Poortman 2018). Additionally, the role of cohabitation is complex: some couples use cohabitation as a trial prior to marriage, some prefer to cohabitate with no intent to marry, and some skip cohabitation and get married prior to living together. This suggests that while cohabitation itself is a heterogeneous category, it is distinct from marriage and we could improve the overall accuracy of our models if we had a separate dissolution risk for those in this cohabitation phase.  

In the case of casual relationships, I return to the observation that the Kaplan-Meier curve shows that roughly one quarter of all casual relationships will fail within the first month, whereas the exponential models overestimate this survival. And indeed, the first quartile of observations in the empirical data are one month or less. This is likely, at least partially, and artifact of the way that relationships are reported and described in the NSFG. If a respondent reports a partner that they only had sex with once and do not expect to have sex with them again in the future, this relationship is labeled as "ended" and "once". These are the relationships that provide the data for our instantaneous networks when simulating for epidemics. If a respondent reports a relationship beginning in the same month of their interview (one month being the smallest unit of time in the NSFG) but expects to continue to have intercourse with this partner, this relationship is labeled as ongoing and we label these relationships as having duration of 0.5 months. Some of these relationships may be true brand-new relationships, but some of them also may be instantaneous relationships reported on by optimistic respondents. In this scenario, in addition to splitting out cohabitations and marriages, we re-define casual relationships as those relationships those one month and remove those relationships that have lasted less than one month. Figures \@ref(fig:threerels) and \@ref(fig:pplot-threerels) show that this additional stratifications and  redefinition improves the fit by a remarkable amount. 

```{r threerels, fig.align="center", fig.cap="Kaplan-Meier vs. Exponetial with Four Relationship Categories", echo=FALSE, out.width="60%"}
t <- summary(e.reltype3)
plot(km_reltype_weighted3, lty=2, lwd=2,
            conf.int = FALSE,
     col = c(orange, blue, green),
     ylab="S(t)", xlab = "t, Months",
     xlim=c(0,348))
lines(t$`reltype3=3`$est, type = "l", col = green, lwd=2)
lines(t$`reltype3=2`$est, type = "l", col = blue, lwd=2)
lines(t$`reltype3=1`$est, type = "l", col = orange, lwd=2)
legend("right", lty=c(rep(1,3), rep(2,3)), lwd=c(rep(2,12)),
       col=c(rep(c(green, blue, orange),2)),
       legend = c("Marriage", "Cohab", "Other",
                   "K-M: Marriage", "K-M: Cohab", "K-M: Other"), bty="n", cex=0.8, ncol=2)
```
```{r pplot-threerels, echo=F, fig.cap="PP Plot, Kaplan-Meier vs Exponential - By Four Relationship Types", out.width="50%", fig.asp=1, fig.align='center'}
t1 <- t$`reltype3=1`$time
est1 <- t$`reltype3=1`$est
times1 <- km_reltype_weighted3$time[1:269]
survs1 <- km_reltype_weighted3$surv[1:269]
jointtimes1 <- intersect(t1, times1)
indexp1 <- which(t1 %in% jointtimes1)
indexkm1 <- which(times1 %in% jointtimes1)

t2 <- t$`reltype3=2`$time
est2 <- t$`reltype3=2`$est
times2 <- km_reltype_weighted3$time[270:548]
survs2 <- km_reltype_weighted3$surv[270:548]
jointtimes2 <- intersect(t2, times2)
indexp2 <- which(t2 %in% jointtimes2)
indexkm2 <- which(times2 %in% jointtimes2)

t3 <- t$`reltype3=3`$time
est3 <- t$`reltype3=3`$est
times3 <- km_reltype_weighted3$time[549:length(km_reltype_weighted3$time)]
survs3 <- km_reltype_weighted3$surv[549:length(km_reltype_weighted3$time)]
jointtimes3 <- intersect(t3, times3)
indexp3 <- which(t3 %in% jointtimes3)
indexkm3 <- which(times3 %in% jointtimes3)

plot(x=survs1[indexkm1], y=est1[indexp1], type = "l", col = orange, lwd=2, xlim=c(0,1), ylim=c(0,1),
      xlab="Kaplan-Meier", ylab="Fitted Exponential by Race")
lines(x=survs2[indexkm2], y=est2[indexp2], type = "l", col = blue, lwd=2)
lines(x=survs3[indexkm3], y=est3[indexp3], type = "l", col = green, lwd=2)
abline(0,1)
legend("topleft", lwd=2, col=c(orange, blue, green),
       legend = c("Casual","Cohabitation", "Marriage"), bty="n", cex=0.8)
```

## Summary of Model Fits and Discussion
```{r aic-full, echo=FALSE}
a <- round(c(AIC(expFit), AIC(weibFit), AIC(gammaFit), AIC(e.agecat), AIC(e.race), AIC(e.network), AIC(e.reltype3)))
casual <- c(round(AIC(e.casual)), "", "", round(AIC(e.agecat.Other)), round(AIC(e.race.Other)), "", "")
marcoh <- c(round(AIC(e.marcoh)),  "", "", round(AIC(e.agecat.Marcoh)), round(AIC(e.race.Marcoh)), "", "")
t <- c("Exponential", "Weibull", "Gamma", "Age Category", "Race", "Reltype-2", "Reltype-4")

atab <- cbind(t,a, casual, marcoh)
kable(atab, booktabs=T, col.names = c("", "All Relationships", "Casual", "Marriage/Cohab"),
      caption="AIC ") %>%
  kable_styling() %>%
    pack_rows("Duration-Only", 1,3) %>%
    pack_rows("Ego Attributes", 4, 5) %>%
    pack_rows("Relationship Type", 6,7)


#b <- round(c(BIC(expFit), BIC(weibFit), BIC(gammaFit), BIC(e.agecat), BIC(e.race), BIC(e.network), BIC(e.reltype4)))
#casualb <- c(round(BIC(e.casual)), "", "", round(BIC(e.agecat.Other)), round(BIC(e.race.Other)), "", "")
#marcohb <- c(round(BIC(e.marcoh)),  "", "", round(BIC(e.agecat.Marcoh)), round(BIC(e.race.Marcoh)), "", "")
#t <- c("Exponential", "Weibull", "Gamma", "Age Category", "Race", "Reltype-2", "Reltype-4")

#btab <- cbind(t,b, casualb, marcohb)
#kable(btab, booktabs=T, col.names = c("", "All Relationships", "Casual", "Marriage/Cohab"),
#      caption="AIC ") %>%
#  kable_styling() %>%
#    pack_rows("Duration-Only", 1,3) %>%
#    pack_rows("Ego Attributes", 4, 5) %>%
#    pack_rows("Relationship Type", 6,7)
```
While age category and race/ethnicity of individuals may be important factors in determining the rate of relationship formation and partner selection, these covariates add little to the overall model fit of relationship *dissolution*. Both overall and within each of the two original relationship types, age category and race/ethnicity of the reporting ego have very little effect on the AIC, particularly among the casual relationships. This suggests a somewhat more universal experience for casual relationships, although from the p-p-plots and survival curves we can see that there is a consistent lack of fit at the start, suggesting that there is still heterogeneity in dissolution risk not explained by age or race: across the board, if relationships are going to fail, do so very quickly. Model fit is most dramatically improved when we redefine our definition of casual relationships to exclude relationships should possibly have been originally classified as instantaneous, and when we stratify the long relationships into marriages and cohabitation. Indeed, the small improvement in model fit among young egos and Non-Hispanic Black egos can likely be explained by this separation. Figure \@ref(fig:props) shows the proportion of the types of relationships by race/ethnicity and age category. Relative to the other groups, Non-Hispanic Blacks have a higher proportion of cohabitations relative to marriages than the other groups, and the same is true for the two youngest age categories. So much of the difference observed between groups in the grouped long-duration network can likely be attributed to the higher proportion of cohabitations in these groups, which we capture better when we split by relationship type rather than ego attribute. It appears that within these three final categories (casual relationships one month or longer, cohabitations, and marriages) relationship lengths across the lifecourse *can* be reasonably approximated by an exponential process.    
```{r props, echo=F, fig.cap="Proportion of Relationships Types by Race and Age Category", fig.align='center', out.width="60%"}
s <- as_survey_design(dat, id=ego, weights=e.weight)
d <- s %>% mutate(reltype=as.factor(reltype)) %>%
  group_by(e.race, reltype) %>%
  summarize(n=survey_total()) %>%
  group_by(e.race) %>%
  mutate(prop=n/sum(n))

a <- s %>% mutate(reltype=as.factor(reltype)) %>%
  group_by(e.agecat, reltype) %>%
  summarize(n=survey_total()) %>%
  group_by(e.agecat) %>%
  mutate(prop=n/sum(n))

dplot <- d %>% ggplot(aes(x=e.race, y=prop, fill=reltype)) +
  geom_bar(stat="identity") +
  xlab("Race/Ethnicity") +
  ylab("Proportion of Relationships") +
  theme(legend.position = "left", axis.text.x = element_text(angle = 30)) +
  scale_fill_discrete(name = "Type", type = c(blue, green, orange)) +
  scale_x_discrete(labels=c("b" = "NH Black", "h" = "Hispanic",
                              "o" = "Other", "w" = "White"))

aplot <- a %>% ggplot(aes(x=e.agecat, y=prop, fill=reltype)) +
  geom_bar(stat="identity") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 30),
        axis.text.y = element_blank(),
        axis.title.y=element_blank()) +
  xlab("Age Category") +
  scale_fill_manual(values=c(blue, green, orange))


suppressWarnings(grid.arrange(dplot, aplot, ncol=2))
```
These results have some implications for STERGMs developed for epidemic models moving forward, and two obvious strategies come to mind. The first and most straightforward given the current workflow would be to simply add an additional dynamic network based on the subsets in Figure \@ref(fig:threerels) and add the relationships that we re-classified as instantaneous (but reported on by optimistic respondents) to the data that informs the instantaneous network. Given that the usual length of each time step in these simulations is one week and the smallest unit of time in the NSFG we may have a mismatch if we continue to assume that these relationships only last one week or that only one sex act occurs. Of course, some of these suggestions, particularly relating to the instantaneous network, may not necessarily be relevant when using survey data sources that were designed with mathematical modeling in mind, like the ARTnet survey for MSM (@Weiss2020).  
A more parsimonious solution however, would be to have a single dynamic network that captures all relationships (or at least all relationships longer than one month) with time-varying dissolution rates by relationship type.  In the current framework and ignoring instantaneous relationships for a moment, marriages and cohabitations are label as such from day one, and casual relationships are not allowed to transition into a longer relationships, which, while we are able to accurately model the prevalence of each relationship type, is still somewhat awkward. With this approach, each relationships would begin as casual and transition type over time, with the constant hazard assumption maintained *within* each relationship type, but could vary over the full duration of each relationship. This representation of relationships as having decreasing dissolution probabilities over time provides a more intuitive framework for the structure of relationship in these models. As of writing this chapter, the statistical tools needed to label each relationship as a specific type with distinct dissolution probabilities (valued TERGMs) are not currently available, but it may be possible to handle the transition and labeling of relationships within the EpiModel API as a work-around.


